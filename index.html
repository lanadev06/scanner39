<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Code 39 Scanner</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f5f5;
        color: #333;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
      }

      .container {
        width: 100%;
        max-width: 600px;
        text-align: center;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        padding: 30px;
      }

      .header {
        margin-bottom: 30px;
      }

      .logo {
        width: 80px;
        height: 80px;
        margin: 0 auto 20px;
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        font-weight: bold;
        box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
      }

      .header h1 {
        font-size: 2.2em;
        margin-bottom: 10px;
        color: #ff6b35;
      }

      .header p {
        font-size: 1.1em;
        color: #666;
      }

      .scanner-container {
        position: relative;
        width: 100%;
        margin: 30px 0;
        background: #f8f8f8;
        border-radius: 15px;
        padding: 20px;
        overflow: hidden; /* –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –≤–∏–¥–µ–æ Quagga –Ω–µ –≤—ã–ª–µ–∑–∞–ª–æ */
      }

      #video {
        width: 100%;
        height: 300px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        object-fit: cover;
        background: #000;
      }

      .scanner-frame {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 250px;
        height: 120px;
        border: 4px solid #ff6b35;
        border-radius: 12px;
        box-shadow: 0 0 0 2000px rgba(0, 0, 0, 0.3);
        pointer-events: none;
      }

      .scanner-line {
        position: absolute;
        width: 100%;
        height: 3px;
        background: #ff6b35;
        animation: scan 2s infinite ease-in-out;
      }

      @keyframes scan {
        0%,
        100% {
          top: 10%;
        }
        50% {
          top: 90%;
        }
      }

      .controls {
        margin: 25px 0;
      }

      .btn {
        background: #ff6b35;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 1.1em;
        border-radius: 50px;
        cursor: pointer;
        margin: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
      }

      .btn:hover {
        background: #f7931e;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .result {
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        color: white;
        padding: 25px;
        border-radius: 15px;
        margin: 25px 0;
        box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
      }

      .result h3 {
        margin-bottom: 15px;
        font-size: 1.3em;
      }

      #resultText {
        font-size: 2.5em;
        font-weight: bold;
        color: white;
        word-break: break-all;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .status {
        margin: 20px 0;
        font-style: italic;
        color: #666;
        font-size: 1.1em;
      }

      .error {
        color: #ff6b6b;
        background: rgba(255, 107, 53, 0.1);
        padding: 15px;
        border-radius: 10px;
        margin: 15px 0;
        border: 2px solid #ff6b6b;
      }

      .examples {
        background: #f8f8f8;
        padding: 20px;
        border-radius: 15px;
        margin: 20px 0;
        border-left: 5px solid #ff6b35;
      }

      .examples h4 {
        color: #ff6b35;
        margin-bottom: 15px;
      }

      .example-item {
        display: flex;
        justify-content: space-between;
        margin: 10px 0;
        padding: 10px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .footer {
        margin-top: 30px;
        font-size: 0.9em;
        color: #999;
      }

      @media (max-width: 480px) {
        .container {
          padding: 20px;
        }

        .header h1 {
          font-size: 1.8em;
        }

        #video {
          height: 250px;
        }

        .scanner-frame {
          width: 200px;
          height: 100px;
        }

        .btn {
          padding: 12px 25px;
          font-size: 1em;
        }

        #resultText {
          font-size: 2em;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="logo">SC</div>
        <h1>üì∑ Code 39 Scanner</h1>
        <p>–ü—Ä–æ—Å—Ç–æ–π —Å–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤ - –Ω–∞–≤–µ–ª –∏ –ø–æ–ª—É—á–∏–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
      </div>
      <div class="scanner-container" id="scannerRoot">
        <!-- –í–∞–∂–Ω–æ: —ç—Ç–æ—Ç <video> –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è –¥–∏–∑–∞–π–Ω–∞, –Ω–æ —Å–∞–º –ø–æ—Ç–æ–∫ —Ç–µ–ø–µ—Ä—å —Ä–µ–Ω–¥–µ—Ä–∏—Ç Quagga –≤–Ω—É—Ç—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
        <video id="video" playsinline autoplay muted></video>
        <div class="scanner-frame">
          <div class="scanner-line"></div>
        </div>
        <div
          id="scannerStatus"
          style="
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 107, 53, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            display: none;
          "
        >
          üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...
        </div>
      </div>
      <div
        class="instructions"
        style="
          background: #e8f4fd;
          padding: 15px;
          border-radius: 10px;
          margin: 15px 0;
          border-left: 4px solid #2196f3;
        "
      >
        <h4 style="color: #1976d2; margin-bottom: 10px">
          üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:
        </h4>
        <ol style="text-align: left; color: #333">
          <li>–ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É"</li>
          <li>–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</li>
          <li>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥ Code 39</li>
          <li>–î–µ—Ä–∂–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ 10-30 —Å–º</li>
          <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —à—Ç—Ä–∏—Ö-–∫–æ–¥ —Ö–æ—Ä–æ—à–æ –æ—Å–≤–µ—â–µ–Ω</li>
        </ol>
      </div>
      <div class="controls">
        <button id="startBtn" class="btn">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
        <button id="stopBtn" class="btn" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <button id="testBtn" class="btn" style="background: #28a745">üß™ –¢–µ—Å—Ç</button>
        <button id="manualTestBtn" class="btn" style="background: #9c27b0">
          üîç –†—É—á–Ω–æ–π —Ç–µ—Å—Ç
        </button>
        <button id="testScannerBtn" class="btn" style="background: #ff9800">
          üî¨ –¢–µ—Å—Ç —Å–∫–∞–Ω–µ—Ä–∞
        </button>
      </div>
      <div class="status" id="status">–ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞</div>
      <div class="result">
        <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
        <div id="resultText">‚Äî</div>
      </div>
      <div class="examples">
        <h4>üìã –ü—Ä–∏–º–µ—Ä—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤:</h4>
        <div class="example-item">
          <span>3 —Ü–∏—Ñ—Ä—ã:</span>
          <span> <strong>123</strong> </span>
        </div>
        <div class="example-item">
          <span>4 —Ü–∏—Ñ—Ä—ã:</span>
          <span> <strong>4567</strong> </span>
        </div>
      </div>
      <div id="error" class="error" style="display: none"></div>
      <div class="footer">
        <p>–†–∞–±–æ—Ç–∞–µ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö</p>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.1/dist/quagga.min.js"></script>
    <script>
      // === –£–¢–ò–õ–ò–¢–´ ===
      const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

      // –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–∏–∑—É–∞–ª—å–Ω–æ)
      function testSimple() {
        const resultText = document.getElementById("resultText");
        const status = document.getElementById("status");
        if (resultText && status) {
          const testCodes = ["264.45.16.15", "123", "4567", "789", "1234"];
          const randomCode = testCodes[Math.floor(Math.random() * testCodes.length)];
          resultText.textContent = randomCode;
          status.textContent = `–¢–µ—Å—Ç: ${randomCode}`;
          resultText.style.transform = "scale(1.1)";
          setTimeout(() => {
            resultText.style.transform = "scale(1)";
          }, 200);
        }
      }

      // –§—É–Ω–∫—Ü–∏—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ (–æ—Å—Ç–∞–≤–ª–µ–Ω–∞)
      function manualTest() {
        const resultText = document.getElementById("resultText");
        const status = document.getElementById("status");
        if (resultText && status) {
          status.textContent = "–ò–º–∏—Ç–∞—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...";
          setTimeout(() => {
            const testCodes = ["264.45.16.15", "123", "4567", "789", "1234"];
            const randomCode =
              testCodes[Math.floor(Math.random() * testCodes.length)];
            resultText.textContent = randomCode;
            status.textContent = `–®—Ç—Ä–∏—Ö-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω: ${randomCode}`;
            resultText.style.transform = "scale(1.1)";
            setTimeout(() => {
              resultText.style.transform = "scale(1)";
            }, 200);
          }, 2000);
        }
      }

      class BarcodeScanner {
        constructor() {
          this.video = document.getElementById("video");
          this.startBtn = document.getElementById("startBtn");
          this.stopBtn = document.getElementById("stopBtn");
          this.testBtn = document.getElementById("testBtn");
          this.manualTestBtn = document.getElementById("manualTestBtn");
          this.testScannerBtn = document.getElementById("testScannerBtn");
          this.resultText = document.getElementById("resultText");
          this.status = document.getElementById("status");
          this.error = document.getElementById("error");
          this.scannerStatus = document.getElementById("scannerStatus");
          this.scannerRoot = document.getElementById("scannerRoot");

          this.isScanning = false;
          this.lastScannedCode = null;
          this.frameCount = 0;
          this.noDetectionTimer = null;
          this.NO_DETECTION_MS = 8000; // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –¥–æ–ª–≥–æ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

          // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
          this.startScanner = this.startScanner.bind(this);
          this.stopScanner = this.stopScanner.bind(this);
          this.testScanner = this.testScanner.bind(this);
          this.testScannerFunctionality = this.testScannerFunctionality.bind(this);
          this.onBarcodeDetected = this.onBarcodeDetected.bind(this);
          this.handleVisibility = this.handleVisibility.bind(this);
        }

        initialize() {
          this.initEventListeners();
          document.addEventListener("visibilitychange", this.handleVisibility);
        }

        initEventListeners() {
          this.startBtn?.addEventListener("click", this.startScanner);
          this.stopBtn?.addEventListener("click", this.stopScanner);
          this.testBtn?.addEventListener("click", testSimple);
          this.manualTestBtn?.addEventListener("click", manualTest);
          this.testScannerBtn?.addEventListener(
            "click",
            this.testScannerFunctionality
          );
        }

        async startScanner() {
          try {
            this.showError("");
            this.status.textContent = "–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...";

            // –í–ê–ñ–ù–û: –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É –≤—Ä—É—á–Ω—É—é. –ü—É—Å—Ç—å Quagga —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ—Ç–æ–∫–æ–º.
            // –≠—Ç–æ –∏–∑–±–µ–≥–∞–µ—Ç –æ—à–∏–±–∫–∏ NotReadableError/–¥–≤–æ–π–Ω–æ–≥–æ –∑–∞—Ö–≤–∞—Ç–∞ –∫–∞–º–µ—Ä—ã.

            await this.startBarcodeDetection();
            this.isScanning = true;
            this.startBtn.disabled = true;
            this.stopBtn.disabled = false;
            this.status.textContent = "–°–∫–∞–Ω–µ—Ä –≥–æ—Ç–æ–≤! –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥ Code 39";
          } catch (error) {
            this.processCameraError(error);
          }
        }

        startBarcodeDetection() {
          return new Promise((resolve, reject) => {
            // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —Å–Ω–∏–º–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏ —Ä–∞–Ω–µ–µ
            try {
              Quagga.offDetected && Quagga.offDetected(this.onBarcodeDetected);
            } catch (_) {}

            const constraints = {
              width: { min: 640, ideal: 1280, max: 1920 },
              height: { min: 480, ideal: 720, max: 1080 },
              facingMode: "environment",
              aspectRatio: { ideal: 16 / 9 },
            };

            Quagga.init(
              {
                inputStream: {
                  name: "Live",
                  type: "LiveStream",
                  target: this.scannerRoot, // —Ä–µ–Ω–¥–µ—Ä–∏–º –≤–∏–¥–µ–æ –≤–Ω—É—Ç—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–¥–∏–∑–∞–π–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω)
                  constraints,
                },
                decoder: {
                  readers: ["code_39_reader"],
                },
                locate: true,
                numOfWorkers: navigator.hardwareConcurrency || 4,
                locator: {
                  patchSize: "medium",
                  halfSample: true,
                },
                frequency: 10,
              },
              async (err) => {
                if (err) {
                  reject(err);
                  return;
                }

                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤–∏–¥–µ–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç—Å—è (–æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è iOS –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ muted+playsinline)
                try {
                  const videoEl = this.scannerRoot.querySelector("video");
                  if (videoEl) {
                    videoEl.setAttribute("playsinline", "");
                    videoEl.setAttribute("muted", "");
                    videoEl.muted = true;
                    await videoEl.play().catch(() => {});
                  }
                } catch (_) {}

                Quagga.onDetected(this.onBarcodeDetected);
                Quagga.onProcessed(() => {
                  this.frameCount++;
                  if (this.scannerStatus && this.frameCount % 15 === 0) {
                    this.scannerStatus.style.display = "block";
                    setTimeout(() => {
                      if (this.scannerStatus) this.scannerStatus.style.display = "none";
                    }, 300);
                  }
                });

                Quagga.start();
                this.resetNoDetectionTimer();
                resolve();
              }
            );
          });
        }

        resetNoDetectionTimer() {
          clearTimeout(this.noDetectionTimer);
          this.noDetectionTimer = setTimeout(() => {
            // –ï—Å–ª–∏ –¥–æ–ª–≥–æ –Ω–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–Ω—è—Ç–Ω—É—é –æ—à–∏–±–∫—É, –Ω–æ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä
            this.handleError(
              "–ù–µ —É–¥–∞—ë—Ç—Å—è —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —à—Ç—Ä–∏—Ö‚Äë–∫–æ–¥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ –∏ –Ω–∞–≤–µ–¥–∏—Ç–µ —Ä–∞–º–∫—É —Ç–æ—á–Ω–æ –Ω–∞ –∫–æ–¥."
            );
          }, this.NO_DETECTION_MS);
        }

        onBarcodeDetected(result) {
          // result –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π (–ø—Ä–∏ —Ç–µ—Å—Ç–∞—Ö) –∏–ª–∏ –æ–±—ä–µ–∫—Ç–æ–º –æ—Ç Quagga
          const code = typeof result === "string" ? result : result?.codeResult?.code;
          if (!code) return;

          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –æ—Ç—Å—É—Ç—Å–≤–∏—è –¥–µ—Ç–µ–∫—Ü–∏–∏
          this.resetNoDetectionTimer();

          if (this.lastScannedCode === code) return; // –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–æ–≤
          this.lastScannedCode = code;

          if (this.isValidCode39(code)) {
            this.resultText.textContent = code;
            this.status.textContent = `–®—Ç—Ä–∏—Ö-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω: ${code}`;
            this.flashFrame(true);
            this.playBeepSound();

            // –ê–≤—Ç–æ–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ
            setTimeout(() => {
              if (this.isScanning) {
                this.resultText.textContent = "‚Äî";
                this.status.textContent = "–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...";
                this.lastScannedCode = null;
              }
            }, 5000);
          } else {
            // –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–ª—è –Ω–∞—à–∏—Ö –ø—Ä–∞–≤–∏–ª –∫–æ–¥ ‚Äî —Å–æ–æ–±—â–∞–µ–º –æ–± –æ—à–∏–±–∫–µ
            this.flashFrame(false);
            this.handleError(
              `–ö–æ–¥ –Ω–∞–π–¥–µ–Ω, –Ω–æ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ —Ñ–æ—Ä–º–∞—Ç Code 39/–ø—Ä–∞–≤–∏–ª–∞: ${code}`
            );
          }
        }

        playBeepSound() {
          try {
            const audioContext = new (window.AudioContext ||
              window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.1);
          } catch (_) {
            // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ WebAudio –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
          }
        }

        flashFrame(success) {
          const frame = document.querySelector(".scanner-frame");
          if (!frame) return;
          const original = frame.style.borderColor || "#FF6B35";
          frame.style.borderColor = success ? "lime" : "#FF6B6B";
          setTimeout(() => (frame.style.borderColor = original), 1200);
        }

        isValidCode39(code) {
          // –†–∞–∑—Ä–µ—à–∞–µ–º: 3‚Äì4 —Ü–∏—Ñ—Ä—ã, —Ñ–æ—Ä–º–∞—Ç —Å —Ç–æ—á–∫–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä 264.45.16.15),
          // –∞ —Ç–∞–∫–∂–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –Ω–∞–±–æ—Ä —Å–∏–º–≤–æ–ª–æ–≤ Code39
          if (/^\d{3,4}$/.test(code)) return true;
          if (/^\d+\.\d+\.\d+\.\d+$/.test(code)) return true;
          return /^[A-Z0-9\-\.\$\/\+\%\s]+$/.test(code);
        }

        async stopScanner() {
          this.isScanning = false;
          this.lastScannedCode = null;
          this.frameCount = 0;
          clearTimeout(this.noDetectionTimer);

          this.scannerStatus && (this.scannerStatus.style.display = "none");

          try {
            Quagga.offDetected && Quagga.offDetected(this.onBarcodeDetected);
          } catch (_) {}

          try {
            await Quagga.stop();
          } catch (_) {}

          // –ß–∏—Å—Ç–∏–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤–∏–¥–µ–æ-—ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–æ—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞—à –ø—É—Å—Ç–æ–π #video –¥–ª—è –¥–∏–∑–∞–π–Ω–∞)
          try {
            const nodes = Array.from(this.scannerRoot.querySelectorAll("canvas, video"));
            nodes.forEach((n) => {
              if (n.id !== "video") n.remove();
            });
          } catch (_) {}

          // –û–±–Ω–æ–≤–ª—è–µ–º UI
          this.resultText.textContent = "‚Äî";
          this.startBtn.disabled = false;
          this.stopBtn.disabled = true;
          this.status.textContent = "–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞";
          this.showError("");
        }

        handleError(message) {
          this.error.textContent = message;
          this.error.style.display = "block";
          this.status.textContent = "–û—à–∏–±–∫–∞";
        }

        showError(message) {
          if (message) {
            this.error.textContent = message;
            this.error.style.display = "block";
          } else {
            this.error.style.display = "none";
          }
        }

        processCameraError(error) {
          console.error("Camera error:", error);
          const name = error?.name || "UnknownError";
          if (name === "NotAllowedError") {
            this.handleError(
              "–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â—ë–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
            );
          } else if (name === "NotFoundError") {
            this.handleError(
              "–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –µ—Å—Ç—å –∫–∞–º–µ—Ä–∞."
            );
          } else if (name === "NotReadableError") {
            this.handleError(
              "–ö–∞–º–µ—Ä–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º. –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –∫–∞–º–µ—Ä—É."
            );
          } else {
            this.handleError("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: " + (error.message || name));
          }
        }

        testScanner() {
          const testCodes = [
            "264.45.16.15",
            "123",
            "4567",
            "789",
            "1234",
          ];
          const randomCode = testCodes[Math.floor(Math.random() * testCodes.length)];
          this.lastScannedCode = null; // —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø–æ–≤—Ç–æ—Ä
          this.onBarcodeDetected(randomCode);
          this.status.textContent = `–¢–µ—Å—Ç: ${randomCode}`;
        }

        testScannerFunctionality() {
          if (!this.isScanning) {
            this.status.textContent = "–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–∞–º–µ—Ä—É!";
            return;
          }
          const testCode = "264.45.16.15";
          this.onBarcodeDetected(testCode);
          this.status.textContent = `–¢–µ—Å—Ç —Å–∫–∞–Ω–µ—Ä–∞: ${testCode}`;
        }

        handleVisibility() {
          if (document.hidden && this.isScanning) {
            // –°–∫—Ä—ã–ª–∏ –≤–∫–ª–∞–¥–∫—É ‚Äî —Å—Ç–∞–≤–∏–º –Ω–∞ –ø–∞—É–∑—É, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —á—ë—Ä–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞/–æ—à–∏–±–æ–∫ —É Safari
            Quagga.pause && Quagga.pause();
          } else if (!document.hidden && this.isScanning) {
            Quagga.start && Quagga.start();
          }
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const scanner = new BarcodeScanner();
        scanner.initialize();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ API
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          scanner.handleError("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ");
        }
      });
    </script>
  </body>
</html>
