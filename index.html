<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <title>ScannerOGP</title>
        <meta name="description" content="–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤ ScannerOGP –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤">
        <meta name="theme-color" content="#ff6b35">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        <meta name="apple-mobile-web-app-title" content="ScannerOGP">
        <link rel="icon" type="image/png" href="scannerlogo.png">
        <link rel="apple-touch-icon" href="scannerlogo.png">
        <link rel="manifest" href="manifest.json">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:#f5f5f5;color:#333;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px}
.container{width:100%;max-width:600px;text-align:center;background:#fff;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.1);padding:30px}
.header{margin-bottom:30px}
.logo{width:80px;height:80px;margin:0 auto 20px;background:linear-gradient(135deg,#dfcec7 0%,#ffffff 100%);border-radius:15px;display:flex;align-items:center;justify-content:center;box-shadow:0 5px 15px rgba(255,107,53,.3)}
.control-panel .logo{width:60px;height:60px;margin:0 auto 15px}
.logo-btn{border:none;background:none;cursor:pointer;transition:transform .2s ease}
.logo-btn:hover{transform:scale(1.05)}
.logo-btn:active{transform:scale(0.95)}
.navigation-menu{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(10px);z-index:1000;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;transition:all .2s ease}
.menu-header{margin-bottom:40px;text-align:center}
.menu-header .logo{width:80px;height:80px;margin:0 auto 20px;box-shadow:0 8px 25px rgba(255,107,53,.4)}
.menu-items{display:flex;flex-direction:column;gap:12px;width:100%;max-width:350px}
.menu-item{padding:18px 24px;border:none;border-radius:16px;font-size:15px;font-weight:500;cursor:pointer;transition:all .25s ease;text-align:left;position:relative;overflow:hidden;background:rgba(255,255,255,.95);color:#333;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.menu-item::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);transition:left .5s ease}
.menu-item:hover::before{left:100%}
.menu-item:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,0,0,.15);background:rgba(255,255,255,1)}
.menu-item:active{transform:translateY(0)}
.menu-item-scan{border-left:4px solid #ff6b35}
.menu-item-manual{border-left:4px solid #ff6b35}
.menu-item-auth{border-left:4px solid #28a745}
.menu-item-list{border-left:4px solid #6c757d}
.menu-item-support{border-left:4px solid #007bff}
.menu-item-info{border-left:4px solid #dc3545}
.logo img{width:100%;height:100%;object-fit:contain;border-radius:15px}
.header h1{font-size:2.2em;margin-bottom:10px;color:#ff6b35}
.scanner-wrapper{display:flex;gap:20px;margin-bottom:20px}
.scanner-container{position:relative;width:65%;height:400px;background:#000;border-radius:15px;overflow:hidden}
#scannerRoot video,#scannerRoot canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:1}
.scanner-frame{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:min(88%,380px);height:150px;border:4px solid #ff6b35;border-radius:12px;
  box-shadow:0 0 0 2000px rgba(0,0,0,.3);pointer-events:none;z-index:2}
.scanner-line{position:absolute;left:0;right:0;height:3px;background:#ff6b35;animation:scan 2s infinite ease-in-out;z-index:2}
@keyframes scan{0%,100%{top:10%}50%{top:90%}}
.scan-status{position:absolute;top:10px;left:10px;background:rgba(255,107,53,.9);color:#fff;padding:5px 10px;border-radius:5px;font-size:12px;z-index:3}
.controls{margin:25px 0}
.control-panel{width:30%;height:400px;padding:20px;text-align:center;display:flex;flex-direction:column;justify-content:space-between;align-items:center}

.result{position:relative;background:linear-gradient(135deg,#ff6b35 0%,#f7931e 100%);color:#fff;padding:25px;border-radius:15px;margin:25px 0;box-shadow:0 8px 25px rgba(255,107,53,.3);transition:all .3s ease;clear:both}
.result.actual{background:linear-gradient(135deg,#28a745 0%,#20c997 100%);box-shadow:0 8px 25px rgba(40,167,69,.3)}
.version-text{position:absolute;top:5px;right:10px;color:#fff;font-size:12px;font-weight:600}
.loading-overlay{position:absolute;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;border-radius:15px;z-index:5}
.loading-text{color:#fff;font-size:14px;font-weight:600;margin-top:10px;text-align:center}
.result-fields{display:flex;flex-direction:column;gap:15px}
.result-field{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.2)}
.result-field:last-child{border-bottom:none}
.field-label{font-weight:600;font-size:1.1em;color:#fff;text-shadow:1px 1px 2px rgba(0,0,0,.3)}
.field-value{font-size:1.2em;font-weight:700;color:#fff;text-shadow:1px 1px 2px rgba(0,0,0,.3);word-break:break-all;text-align:right;flex:1;margin-left:20px}

.status{margin:20px 0;font-style:italic;color:#666;font-size:1.1em;clear:both}
.zoom-controls{margin:10px 0;text-align:center;transition:opacity .3s ease;overflow:hidden}
.zoom-label{margin-bottom:10px;font-weight:600;color:#333;font-size:1em}
.zoom-buttons{display:flex;justify-content:center;gap:6px;flex-wrap:nowrap;align-items:center;width:fit-content;margin:0 auto}
.zoom-btn{width:32px;height:32px;padding:0;font-size:16px;font-weight:bold;border-radius:6px;opacity:0.6;transition:all .2s ease;display:flex;align-items:center;justify-content:center;line-height:1;box-sizing:border-box;flex:0 0 32px;aspect-ratio:1/1}
.zoom-btn:hover:not(:disabled){opacity:1;transform:scale(1.05)}
.zoom-btn:disabled{opacity:0.3;cursor:not-allowed}

.error{color:#ff6b6b;background:rgba(255,107,53,.1);padding:15px;border-radius:10px;margin:15px 0;border:2px solid #ff6b6b}
.footer{margin-top:30px;font-size:.9em;color:#999}
@media (max-width:480px){.container{padding:20px}.header h1{font-size:1.8em}.scanner-container{height:300px}.scanner-frame{width:92%;height:130px}.control-panel{height:300px}.control-panel .logo{width:50px;height:50px;margin:0 auto 10px}.btn{padding:12px 25px;font-size:1em}#resultText{font-size:2em}.zoom-buttons{width:fit-content;gap:4px}.zoom-btn{width:28px;height:28px;font-size:14px;flex:0 0 28px;aspect-ratio:1/1}}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="scanner-wrapper">
                <div class="scanner-container" id="scannerRoot">
                    <div class="scanner-frame">
                        <div class="scanner-line"></div>
                    </div>
                    <div id="scannerStatus" class="scan-status" style="display:none;">üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...</div>
                </div>
                <div class="control-panel">
                    <div class="controls">
                        <button class="logo logo-btn" id="logoBtn">
                            <img src="scannerlogo.png" alt="Logo">
                        </button>
                        <div class="zoom-controls">
                            <div class="zoom-buttons">
                                <button class="btn btn-outline-secondary btn-sm zoom-btn" id="zoomMinus" disabled>‚àí</button>
                                <button class="btn btn-outline-secondary btn-sm zoom-btn" id="zoomPlus" disabled>+</button>
                            </div>
                        </div>
                        <button id="startBtn" class="btn btn-success btn-lg mb-3">–ø—É—Å–∫</button>
                        <button id="stopBtn" class="btn btn-secondary btn-lg mb-3" disabled>—Å—Ç–æ–ø</button>
                    </div>
                </div>
            </div>
            <div class="status" id="status">–ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞</div>
            <div class="result">
                <div class="result-fields">
                    <div class="result-field">
                        <span class="field-label">–®—Ç—Ä–∏—Ö-–∫–æ–¥:</span>
                        <span class="field-value" id="barcodeValue"></span>
                    </div>
                    <div class="result-field">
                        <span class="field-label">–û–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ:</span>
                        <span class="field-value" id="designationValue">‚Äî</span>
                    </div>
                    <div class="result-field">
                        <span class="field-label">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</span>
                        <span class="field-value" id="nameValue">‚Äî</span>
                    </div>
                    <div class="result-field">
                        <span class="field-label">–ê–≤—Ç–æ—Ä:</span>
                        <span class="field-value" id="authorValue">‚Äî</span>
                    </div>
                    <div class="result-field">
                        <span class="field-label">–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:</span>
                        <span class="field-value" id="dateValue">‚Äî</span>
                    </div>
                </div>
                <div id="versionIndicator" class="version-text" style="display: none;">–í–µ—Ä—Å–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞</div>
                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                    <div class="loading-text">–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞...</div>
                </div>
            </div>
            <div id="error" class="error" style="display:none"></div>
            <!-- –ú–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
            <div id="navigationMenu" class="navigation-menu" style="display: none;">
                <div class="menu-header">
                    <button class="logo logo-btn" id="menuLogoBtn">
                        <img src="scannerlogo.png" alt="Logo">
                    </button>
                </div>
                <div class="menu-items">
                    <button class="menu-item menu-item-scan">üì± –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –®–ö</button>
                    <button class="menu-item menu-item-manual">‚úèÔ∏è –í–≤–æ–¥ –®–ö –≤—Ä—É—á–Ω—É—é</button>
                    <button class="menu-item menu-item-auth">üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</button>
                    <button class="menu-item menu-item-list">üìã –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã—Ö –®–ö</button>
                    <button class="menu-item menu-item-support">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</button>
                    <button class="menu-item menu-item-info">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</button>
                </div>
            </div>
            <div class="footer">
                <div id="pwa-indicator" style="margin-top:10px;font-size:.8em;color:#666;"></div>
            </div>
        </div>
        <!-- ZXing-CPP (WASM) -->
        <script src="https://cdn.jsdelivr.net/npm/zxing-wasm@2/dist/iife/reader/index.js"></script>
        <!-- Quagga2 –∫–∞–∫ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–ª–±—ç–∫ -->
        <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.1/dist/quagga.min.js"></script>
        <script>
class BarcodeScanner {
  constructor(){
    this.startBtn = document.getElementById("startBtn");
    this.stopBtn = document.getElementById("stopBtn");
    this.resultText = document.getElementById("resultText");
    this.status = document.getElementById("status");
    this.error = document.getElementById("error");
    this.scannerRoot = document.getElementById("scannerRoot");
    this.frameEl = document.querySelector(".scanner-frame");

    this.isScanning = false;
    this.engine = null; // 'native' | 'zxing' | 'quagga'
    this.videoEl = null;
    this.mediaStream = null;
    this.videoTrack = null;
    this.zoomControls = null;
    this.currentZoom = 1;

    // –∞–Ω—Ç–∏-–¥—Ä–µ–±–µ–∑–≥
    this.lastCode = null;
    this.candidate = null;
    this.candidateCount = 0;
    this.candidateFirstAt = 0;
    this.lockedUntil = 0;
    this.EMIT_STABLE_FRAMES = 4;
    this.EMIT_STABLE_SAME_MS = 400;
    this.EMIT_COOLDOWN_MS = 1200;
    this.PROCESSING_TIME_MS = 2500; // –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

    this.noDetectionTimer = null;
    this.NO_DETECTION_MS = 8000;
    this.isProcessing = false; // –§–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

    this._rafId = 0;

    this.startScanner = this.startScanner.bind(this);
    this.stopScanner = this.stopScanner.bind(this);
    this._onResize = this._onResize.bind(this);
    this.toggleMenu = this.toggleMenu.bind(this);
  }

  initialize(){
    this.startBtn.addEventListener("click", this.startScanner);
    this.stopBtn.addEventListener("click", this.stopScanner);
    window.addEventListener("resize", this._onResize);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ–º
    this.zoomControls = document.querySelector('.zoom-controls');
    this._setupZoomControls();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –ª–æ–≥–æ—Ç–∏–ø–∞
    const logoBtn = document.getElementById('logoBtn');
    const menuLogoBtn = document.getElementById('menuLogoBtn');
    if (logoBtn) logoBtn.addEventListener('click', this.toggleMenu);
    if (menuLogoBtn) menuLogoBtn.addEventListener('click', this.toggleMenu);
  }

  async startScanner(){
    this._showError("");
    this.status.textContent = "–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...";
    try{
      if (await this._canUseNative()) {
        await this._startCamera();
        this.engine = 'native';
        this._scanNative();
      } else if (window.ZXingWASM) {
        await this._startCamera();
        this.engine = 'zxing';
        await ZXingWASM.readBarcodes(new ImageData(1,1), { formats: ["Code39"] }); // –ø—Ä–æ–≥—Ä–µ–≤
        this._scanZXing();
      } else {
        await this._startQuagga();
        this.engine = 'quagga';
      }

      this.isScanning = true;
      this.startBtn.disabled = true;
      this.startBtn.classList.remove('btn-success');
      this.startBtn.classList.add('btn-secondary');
      this.stopBtn.disabled = false;
      this.stopBtn.classList.remove('btn-secondary');
      this.stopBtn.classList.add('btn-danger');
      this.status.textContent = "–°–∫–∞–Ω–µ—Ä –≥–æ—Ç–æ–≤! –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥ ScannerOGP (1√ó)";
      this.frameEl.style.display = "block";
      
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if (this.zoomControls) {
          // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ zoom
          this._disableZoomControls();
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã
          setTimeout(() => {
            if (this._checkZoomSupport()) {
              // –ö–Ω–æ–ø–∫–∏ —É–∂–µ –≤–∫–ª—é—á–µ–Ω—ã –≤ _checkZoomSupport
            } else {
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å, –µ—Å–ª–∏ zoom –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
              if (this.status.textContent.includes('(1√ó)')) {
                this.status.textContent = "–°–∫–∞–Ω–µ—Ä –≥–æ—Ç–æ–≤! –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥ ScannerOGP";
              }
            }
          }, 800);
        }
      
      this._resetNoDetectionTimer();
    } catch(e){
      this._handleError("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: " + (e?.message || e));
    }
  }

  async _canUseNative(){
    if (!('BarcodeDetector' in window)) return false;
    try{
      const formats = await BarcodeDetector.getSupportedFormats();
      return formats.includes('code_39');
    }catch{ return false; }
  }

  async _startCamera(){
    if (!this.videoEl){
      this.videoEl = document.createElement("video");
      this.videoEl.setAttribute("playsinline","true");
      this.videoEl.autoplay = true;
      this.videoEl.muted = true;
      this.scannerRoot.appendChild(this.videoEl);
    }
    this.mediaStream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: "environment" },
        width: { ideal: 1920 }, height: { ideal: 1080 },
        advanced: [{ focusMode: "continuous" }]
      },
      audio: false
    });
    this.videoEl.srcObject = this.mediaStream;
    this.videoTrack = this.mediaStream.getVideoTracks()[0] || null;
    await this._applyAutoFocus();
  }

  // ======= Native (BarcodeDetector) =======
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π API –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  async _scanNative(){
    const detector = new BarcodeDetector({ formats: ['code_39'] });
    const loop = async ()=>{
      if (!this.isScanning || this.engine!=='native') return;
      try{
        const res = await detector.detect(this.videoEl);
        if (res && res.length) this._onCandidate(res[0].rawValue);
      }catch{}
      this._resetNoDetectionTimer();
      this._rafId = requestAnimationFrame(loop);
    };
    this._rafId = requestAnimationFrame(loop);
  }

  // ======= ZXing-WASM =======
  // Fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤ –±–µ–∑ –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ BarcodeDetector
  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∂–µ—Å—Ç—ã –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è –Ω–∞ —Å–≤–æ–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
  async _scanZXing(){
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    const opts = {
      formats: ["Code39"],
      tryHarder: true,
      tryRotate: true,
      tryInvert: true,
      tryDownscale: true,
      minLineCount: 2,
      maxNumberOfSymbols: 1,
      tryCode39ExtendedMode: true,
      binarizer: "LocalAverage"
    };

    const loop = async ()=>{
      if (!this.isScanning || this.engine!=='zxing') return;
      try{
        const { w, h } = this._drawROIToCanvas(this.videoEl, canvas, ctx);
        const imageData = ctx.getImageData(0,0,w,h);
        const results = await ZXingWASM.readBarcodes(imageData, opts);
        if (results && results.length) this._onCandidate(results[0].text);
      }catch{}
      this._resetNoDetectionTimer();
      this._rafId = requestAnimationFrame(loop);
    };
    this._rafId = requestAnimationFrame(loop);
  }

  _drawROIToCanvas(video, canvas, ctx){
    const vr = video.getBoundingClientRect();
    const fr = this.frameEl.getBoundingClientRect();
    const sx = Math.max(0, (fr.left - vr.left) / vr.width  * video.videoWidth);
    const sy = Math.max(0, (fr.top  - vr.top ) / vr.height * video.videoHeight);
    const sw = Math.min(video.videoWidth  - sx, fr.width  / vr.width  * video.videoWidth);
    const sh = Math.min(video.videoHeight - sy, fr.height / vr.height * video.videoHeight);
    const w = Math.max(360, Math.floor(sw));
    const h = Math.max(160, Math.floor(sh));
    canvas.width = w; canvas.height = h;
    ctx.drawImage(video, sx, sy, sw, sh, 0, 0, w, h);
    return { w, h };
  }

  // ======= Quagga2 (fallback) =======
  async _startQuagga(){
    return new Promise((resolve,reject)=>{
      try{ Quagga.offDetected?.(()=>{}); }catch(_){}
      const area = this._computeROI();
      const constraints = {
        facingMode: { ideal: "environment" },
        width:{ideal:1920}, height:{ideal:1080},
        advanced:[{ focusMode: "continuous" }]
      };
      Quagga.init({
        inputStream:{ name:"Live", type:"LiveStream", target:this.scannerRoot, constraints, area },
        locator:{ patchSize:"x-small", halfSample:false },
        decoder:{ readers:["code_39_reader"], multiple:false },
        locate:true,
        numOfWorkers: navigator.hardwareConcurrency || 4,
        frequency: 25
      }, (err)=>{
        if (err) return reject(err);
        Quagga.onDetected((res)=>{
          const code = res?.codeResult?.code;
          if (code) this._onCandidate(code);
          this._resetNoDetectionTimer();
        });
        Quagga.start();

        setTimeout(async ()=>{
          const v = this.scannerRoot.querySelector("video");
          if (v){ v.setAttribute("playsinline",""); v.muted = true; v.autoplay = true; }
          this.videoEl = v;
          this.mediaStream = v?.srcObject || null;
          this.videoTrack = this.mediaStream?.getVideoTracks?.()[0] || null;
          await this._applyAutoFocus();
        }, 300);

        this._resetNoDetectionTimer();
        resolve();
      });
    });
  }

  _computeROI(){
    const r = this.scannerRoot.getBoundingClientRect();
    const f = this.frameEl.getBoundingClientRect();
    const top = Math.max(0, (f.top - r.top)/r.height*100);
    const left= Math.max(0, (f.left- r.left)/r.width *100);
    const right = Math.max(0, 100 - (f.right - r.left)/r.width *100);
    const bottom= Math.max(0, 100 - (f.bottom- r.top )/r.height*100);
    return { top:`${top}%`, right:`${right}%`, left:`${left}%`, bottom:`${bottom}%` };
  }

  _onCandidate(raw){
    const now = performance.now();
    if (now < this.lockedUntil || this.isProcessing) return; // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

    let code = (raw || "").trim().replace(/^\*|\*$/g, "");
    if (!code) return;

    if (this.candidate === code){
      this.candidateCount++;
    } else {
      this.candidate = code;
      this.candidateCount = 1;
      this.candidateFirstAt = now;
    }

    const longEnough = (now - this.candidateFirstAt) >= this.EMIT_STABLE_SAME_MS;
    if (this.candidateCount >= this.EMIT_STABLE_FRAMES && longEnough){
      this._emitFinal(code);
    }
  }

  _emitFinal(code){
    this.lastCode = code;
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    this.isProcessing = true;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    this._showLoadingOverlay();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞
    const barcodeValue = document.getElementById('barcodeValue');
    if (barcodeValue) {
      barcodeValue.textContent = code;
    }
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
    this._fillResultFields(code);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –≤–µ—Ä—Å–∏–∏ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç —Ä–∞–º–∫–∏
    this._checkVersionAndUpdateUI(code);
    
    this.status.textContent = `–ì–æ—Ç–æ–≤–æ: ${code} (${this.currentZoom}√ó)`;
    this._flashFrame(true);
    this._beep();
    setTimeout(()=> this._flashFrame(false), 900);
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏
    setTimeout(() => {
      this._hideLoadingOverlay();
      this.isProcessing = false;
    }, this.PROCESSING_TIME_MS);
    
    this.lockedUntil = performance.now() + this.EMIT_COOLDOWN_MS;
    this.candidate = null;
    this.candidateCount = 0;
    this.candidateFirstAt = 0;
  }

  async _applyAutoFocus(){
    if (!this.videoTrack?.getCapabilities) return;
    const caps = this.videoTrack.getCapabilities();
    const adv = [];
    
    // –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ñ–æ–∫—É—Å - —É–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ
    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∞–º–∏ –≤—ã–±–µ—Ä—É—Ç –Ω—É–∂–Ω–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –Ω–∞ —Å–≤–æ–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
    if (caps.focusMode?.includes?.("continuous")) {
      adv.push({ focusMode: "continuous" });
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ–∫—É—Å–∞
    if (adv.length > 0) {
      try {
        await this.videoTrack.applyConstraints({ advanced: adv });
      } catch (e) {
        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∞–≤—Ç–æ—Ñ–æ–∫—É—Å:', e);
      }
    }
  }

  _setupZoomControls(){
    if (!this.zoomControls) return;
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫ + –∏ - (–ø—Ä–æ–≤–µ—Ä–∫–∞ zoom –±—É–¥–µ—Ç –ø–æ–∑–∂–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–∞–º–µ—Ä—ã)
    const zoomPlus = document.getElementById('zoomPlus');
    const zoomMinus = document.getElementById('zoomMinus');
    
    if (zoomPlus && zoomMinus) {
      zoomPlus.addEventListener('click', () => this._stepZoom(1));
      zoomMinus.addEventListener('click', () => this._stepZoom(-1));
    }
  }

  _checkZoomSupport(){
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–∞–º–µ—Ä—ã
    if (this.videoTrack?.getCapabilities) {
      const caps = this.videoTrack.getCapabilities();
      
      // –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö –∫–∞–º–µ—Ä—ã
      console.log('–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–∞–º–µ—Ä—ã:', {
        zoom: caps.zoom,
        focusMode: caps.focusMode,
        torch: caps.torch
      });
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ
      if (!caps.zoom || caps.zoom.min === caps.zoom.max || caps.zoom.max <= 1.1) {
        console.log('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ');
        this._disableZoomControls();
        return false;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è zoom
      const min = Math.ceil(caps.zoom.min ?? 1);
      const max = Math.floor(caps.zoom.max ?? 1);
      
      console.log(`–î–æ—Å—Ç—É–ø–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω zoom: ${min}x - ${max}x`);
      
      // –ï—Å–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –º–µ–Ω—å—à–µ 1.3, —Ç–æ zoom –Ω–µ –Ω—É–∂–µ–Ω
      // (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–µ–±-–∫–∞–º–µ—Ä—ã –∏–º–µ—é—Ç –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω)
      if (max < 1.3) {
        console.log('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ, zoom –Ω–µ –Ω—É–∂–µ–Ω');
        this._disableZoomControls();
        return false;
      }
      
      console.log('–ö–Ω–æ–ø–∫–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã');
      this._enableZoomControls();
      return true;
    }
    
    console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–∞–º–µ—Ä—ã');
    this._disableZoomControls();
    return false;
  }

  async _applyZoom(zoom){
    if (!this.videoTrack?.getCapabilities) return;
    
    try {
      const caps = this.videoTrack.getCapabilities();
      if (!caps.zoom) return;
      
      const min = caps.zoom.min ?? 1;
      const max = caps.zoom.max ?? 1;
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
      const clampedZoom = Math.max(min, Math.min(max, zoom));
      
      await this.videoTrack.applyConstraints({
        advanced: [{ zoom: clampedZoom }]
      });
      
      this.currentZoom = clampedZoom;
      console.log(`–ü—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${clampedZoom}x`);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏
      if (this.status.textContent.includes('–ì–æ—Ç–æ–≤–æ:')) {
        this.status.textContent = `–ì–æ—Ç–æ–≤–æ: ${this.lastCode} (${clampedZoom}√ó)`;
      }
      
      // –ö–æ—Ä–æ—Ç–∫–∏–π –∑–≤—É–∫–æ–≤–æ–π —Å–∏–≥–Ω–∞–ª –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è
      this._beepShort();
      
    } catch (e) {
      console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ:', e);
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      this._handleError(`–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ ${zoom}√ó`);
    }
  }

  _enableZoomControls(){
    // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ zoom
    if (this.zoomControls) {
      const zoomMinus = document.getElementById('zoomMinus');
      const zoomPlus = document.getElementById('zoomPlus');
      if (zoomMinus && zoomPlus) {
        zoomMinus.disabled = false;
        zoomPlus.disabled = false;
        zoomMinus.classList.remove('btn-outline-secondary');
        zoomMinus.classList.add('btn-outline-primary');
        zoomPlus.classList.remove('btn-outline-secondary');
        zoomPlus.classList.add('btn-outline-primary');
      }
    }
  }

  _disableZoomControls(){
    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ zoom
    if (this.zoomControls) {
      const zoomMinus = document.getElementById('zoomMinus');
      const zoomPlus = document.getElementById('zoomPlus');
      if (zoomMinus && zoomPlus) {
        zoomMinus.disabled = true;
        zoomPlus.disabled = true;
        zoomMinus.classList.remove('btn-outline-primary');
        zoomMinus.classList.add('btn-outline-secondary');
        zoomPlus.classList.remove('btn-outline-primary');
        zoomPlus.classList.add('btn-outline-secondary');
      }
    }
  }

  _stepZoom(step){
    if (!this.videoTrack?.getCapabilities) return;
    
    const caps = this.videoTrack.getCapabilities();
    if (!caps.zoom) return;
    
    const min = Math.ceil(caps.zoom.min ?? 1);
    const max = Math.floor(caps.zoom.max ?? 1);
    
    // –ù–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â–µ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∑—É–º–∞
    const availableZooms = [1, 2, 3, 4, 5].filter(z => z >= min && z <= max);
    if (availableZooms.length === 0) return;
    
    const currentIndex = availableZooms.indexOf(this.currentZoom);
    let newIndex;
    
    if (step > 0) {
      // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑—É–º
      newIndex = Math.min(currentIndex + 1, availableZooms.length - 1);
    } else {
      // –£–º–µ–Ω—å—à–∞–µ–º –∑—É–º
      newIndex = Math.max(currentIndex - 1, 0);
    }
    
    const newZoom = availableZooms[newIndex];
    if (newZoom !== this.currentZoom) {
      // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ
      this._applyZoom(newZoom);
    }
  }

  _checkVersionAndUpdateUI(code){
    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    const resultElement = document.querySelector('.result');
    const versionIndicator = document.getElementById('versionIndicator');
    
    if (!resultElement || !versionIndicator) return;
    
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –≤–µ—Ä—Å–∏–∏
    // –ü–æ–∫–∞ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ –¥–ª–∏–Ω–µ –∫–æ–¥–∞
    const isActual = code.length >= 5; // –ü—Ä–∏–º–µ—Ä: –∫–æ–¥ –¥–ª–∏–Ω–æ–π 5+ —Å–∏–º–≤–æ–ª–æ–≤ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–º
    
    if (isActual) {
      // –í–µ—Ä—Å–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞ - –∑–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç —Ä–∞–º–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
      resultElement.classList.add('actual');
      versionIndicator.style.display = 'block';
    } else {
      // –í–µ—Ä—Å–∏—è –Ω–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞ - –æ—Ä–∞–Ω–∂–µ–≤—ã–π —Ü–≤–µ—Ç —Ä–∞–º–∫–∏ –∏ —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
      resultElement.classList.remove('actual');
      versionIndicator.style.display = 'none';
    }
  }

  _fillResultFields(code){
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
    const designationValue = document.getElementById('designationValue');
    const nameValue = document.getElementById('nameValue');
    const authorValue = document.getElementById('authorValue');
    const dateValue = document.getElementById('dateValue');
    
    if (designationValue) designationValue.textContent = '073–î-–ü-–≠–≠';
    if (nameValue) nameValue.textContent = '–¢–µ–∫—Å—Ç–æ–≤–∞—è —á–∞—Å—Ç—å';
    if (authorValue) authorValue.textContent = '–ß–µ—Ä–Ω–æ–≤ –Æ—Ä–∏–π';
    if (dateValue) dateValue.textContent = '10.26.2015 16:39:23';
  }

  _clearResultFields(){
    // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    const barcodeValue = document.getElementById('barcodeValue');
    const designationValue = document.getElementById('designationValue');
    const nameValue = document.getElementById('nameValue');
    const authorValue = document.getElementById('authorValue');
    const dateValue = document.getElementById('dateValue');
    
    if (barcodeValue) barcodeValue.textContent = ' ';
    if (designationValue) designationValue.textContent = '‚Äî';
    if (nameValue) nameValue.textContent = '‚Äî';
    if (authorValue) authorValue.textContent = '‚Äî';
    if (dateValue) dateValue.textContent = '‚Äî';
  }

  _showLoadingOverlay(){
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
      loadingOverlay.style.display = 'flex';
    }
  }

  _hideLoadingOverlay(){
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
      loadingOverlay.style.display = 'none';
    }
  }

  toggleMenu(){
    const menu = document.getElementById('navigationMenu');
    if (menu) {
      if (menu.style.display === 'none') {
        menu.style.display = 'flex';
        menu.style.opacity = '0';
        menu.style.transform = 'scale(0.9)';
        setTimeout(() => {
          menu.style.opacity = '1';
          menu.style.transform = 'scale(1)';
        }, 10);
      } else {
        menu.style.opacity = '0';
        menu.style.transform = 'scale(0.9)';
        setTimeout(() => {
          menu.style.display = 'none';
        }, 200);
      }
    }
  }



  _onResize(){
    if (!this.isScanning) return;
    if (this.engine === 'quagga'){
      Quagga.stop?.(); this._startQuagga().catch(()=>{});
    }
  }

  async stopScanner(){
    this.isScanning = false;
    this.startBtn.disabled = false;
    this.startBtn.classList.remove('btn-secondary');
    this.startBtn.classList.add('btn-success');
    this.stopBtn.disabled = true;
    this.stopBtn.classList.remove('btn-danger');
    this.stopBtn.classList.add('btn-secondary');
    this.status.textContent = "–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞";
    this._showError(""); this._flashFrame(false);
    
    // –û—Ç–∫–ª—é—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ–º
    if (this.zoomControls) {
      this._disableZoomControls();
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ
    this.currentZoom = 1;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    this.isProcessing = false;
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    this._hideLoadingOverlay();
    
    // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    this._clearResultFields();
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ü–≤–µ—Ç —Ä–∞–º–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    const resultElement = document.querySelector('.result');
    if (resultElement) {
      resultElement.classList.remove('actual');
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤–µ—Ä—Å–∏–∏
    const versionIndicator = document.getElementById('versionIndicator');
    if (versionIndicator) {
      versionIndicator.style.display = 'none';
    }
    
    cancelAnimationFrame(this._rafId);
    clearTimeout(this.noDetectionTimer);

    try{ Quagga.offDetected?.(()=>{}); Quagga.stop?.(); }catch(_){}
    try{ this.mediaStream?.getTracks?.().forEach(t=>t.stop()); }catch(_){}
    this.engine = null;
  }

  _resetNoDetectionTimer(){
    clearTimeout(this.noDetectionTimer);
    this.noDetectionTimer = setTimeout(()=>{
      this._handleError("–ù–µ —É–¥–∞—ë—Ç—Å—è —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —à—Ç—Ä–∏—Ö-–∫–æ–¥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ/—Ä–µ–∑–∫–æ—Å—Ç—å.");
    }, this.NO_DETECTION_MS);
  }

  _flashFrame(ok){ if (this.frameEl) this.frameEl.style.borderColor = ok ? "lime" : "#ff6b35"; }
  _handleError(msg){ this.error.textContent = msg; this.error.style.display="block"; this.status.textContent="–û—à–∏–±–∫–∞"; }
  _showError(msg){ this.error.style.display = msg ? "block" : "none"; this.error.textContent = msg; }

  _beep(){
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type="square"; o.frequency.setValueAtTime(880, ctx.currentTime);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.15);
      o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.16);
      setTimeout(()=>ctx.close?.(), 250);
    }catch(_){}
  }

  _beepShort(){
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type="sine"; o.frequency.setValueAtTime(660, ctx.currentTime);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.1, ctx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.08);
      o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.09);
      setTimeout(()=>ctx.close?.(), 150);
    }catch(_){}
  }
}


document.addEventListener("DOMContentLoaded", ()=> new BarcodeScanner().initialize());

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker (–û–ë–ù–û–í–õ–ï–ù–ê: –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å, –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const swUrl = new URL('./sw.js', location.href).toString();
      const reg = await navigator.serviceWorker.register(swUrl, { scope: './' });

      reg.update?.();

      if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });

      reg.addEventListener('updatefound', () => {
        const nw = reg.installing;
        if (!nw) return;
        nw.addEventListener('statechange', () => {
          if (nw.state === 'installed' && navigator.serviceWorker.controller) {
            nw.postMessage({ type: 'SKIP_WAITING' });
          }
        });
      });

      let reloaded = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (reloaded) return;
        reloaded = true;
        location.reload();
      });

      updatePWAIndicator('‚úÖ PWA –∞–∫—Ç–∏–≤–µ–Ω - —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω');
    } catch (e) {
      console.log('SW register error', e);
      updatePWAIndicator('‚ö†Ô∏è PWA –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω');
    }
  });
}

function updatePWAIndicator(m){ const el = document.getElementById('pwa-indicator'); if (el) el.innerHTML = m; }
function checkPWAStatus(){
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistration().then(reg => {
      updatePWAIndicator(reg?.active ? '‚úÖ PWA –∞–∫—Ç–∏–≤–µ–Ω - —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω' : '‚è≥ PWA –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
    });
  } else updatePWAIndicator('‚ùå PWA –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
}
document.addEventListener('DOMContentLoaded', checkPWAStatus);
        </script>
    </body>
</html>
