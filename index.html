<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <title>ScannerOGP</title>
        <meta name="description" content="Сканер штрих-кодов ScannerOGP для мобильных устройств">
        <meta name="theme-color" content="#ff6b35">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="apple-mobile-web-app-title" content="ScannerOGP">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="theme-color" content="#ff6b35">
        <meta name="msapplication-TileColor" content="#ff6b35">
        <!-- Специальные мета-теги для Android -->
        <meta name="application-name" content="ScannerOGP">
        <meta name="msapplication-TileImage" content="scannerlogo.png">
        <meta name="msapplication-config" content="none">
        <!-- Android Chrome PWA -->
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="mobile-web-app-title" content="ScannerOGP">
        <!-- Android WebView -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
        <meta name="format-detection" content="telephone=no">
        <meta name="msapplication-tap-highlight" content="no">
        <link rel="icon" type="image/png" href="scannerlogo.png">
        <link rel="apple-touch-icon" href="scannerlogo.png">
        <link rel="manifest" href="manifest.json">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
*{margin:0;padding:0;box-sizing:border-box}
body{min-height:100vh;min-height:100dvh;padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}
body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:#f5f5f5;color:#333;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px}
.container{width:100%;max-width:600px;text-align:center;background:#fff;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.1);padding:30px}
.header{margin-bottom:30px}
.logo{width:110px;margin:0 auto 20px;background:linear-gradient(135deg,#dfcec7 0%,#ffffff 100%);border-radius:15px;display:flex;align-items:center;justify-content:center;box-shadow:0 5px 15px rgba(255,107,53,.3)}
.control-panel .logo{width:80px;height:80px;margin:0 auto 0;transition:all .3s ease;margin-bottom:8px}
.logo-btn{border:none;background:none;cursor:pointer;transition:transform .3s ease;border-radius:15px;overflow:hidden}
.logo-btn:hover{transform:scale(1.05);box-shadow:0 8px 25px rgba(255,107,53,.4)}
.logo-btn:active{transform:scale(0.95)}
.logo-btn:focus{outline:2px solid #ff6b35;outline-offset:2px}
.navigation-menu{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(10px);z-index:1000;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;transition:all .3s ease}
.menu-header{margin-bottom:40px;text-align:center}
.menu-header .logo{width:80px;height:80px;margin:0 auto 20px;box-shadow:0 8px 25px rgba(255,107,53,.4)}
.menu-items{display:flex;flex-direction:column;gap:12px;width:100%;max-width:350px}
.menu-item{padding:18px 24px;border:none;border-radius:16px;font-size:15px;font-weight:500;cursor:pointer;transition:all .3s ease;text-align:left;position:relative;overflow:hidden;background:rgba(255,255,255,.95);color:#333;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.menu-item::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);transition:left .5s ease}
.menu-item:hover::before{left:100%}
.menu-item:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,0,0,.15);background:rgba(255,255,255,1)}
.menu-item:active{transform:translateY(0)}
.menu-item:focus{outline:2px solid #ff6b35;outline-offset:2px}
.menu-item-scan{border-left:4px solid #ff6b35}
.menu-item-manual{border-left:4px solid #ff6b35}
.menu-item-auth{border-left:4px solid #28a745}
.menu-item-list{border-left:4px solid #6c757d}
.menu-item-support{border-left:4px solid #007bff}
.menu-item-info{border-left:4px solid #dc3545}
.logo img{width:100%;height:100%;object-fit:contain;border-radius:15px;transition:all .3s ease}
.header h1{font-size:2.2em;margin-bottom:10px;color:#ff6b35;transition:all .3s ease}
.scanner-wrapper{display:flex;gap:20px;margin-bottom:20px;flex-direction:row;align-items:stretch}
.scanner-container{position:relative;width:65%;height:400px;background:#000;border-radius:15px;overflow:hidden;transition:all .3s ease}
#scannerRoot video,#scannerRoot canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:1}
.scanner-frame{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:min(88%,380px);height:150px;border:4px solid #ff6b35;border-radius:12px;
  box-shadow:0 0 0 2000px rgba(0,0,0,.3);pointer-events:none;z-index:2;transition:all .3s ease}
.scanner-line{position:absolute;left:0;right:0;height:3px;background:#ff6b35;animation:scan 2s infinite ease-in-out;z-index:2;transition:all .3s ease}
@keyframes scan{0%,100%{top:10%}50%{top:90%}}
.scan-status{position:absolute;top:10px;left:10px;background:rgba(255,107,53,.9);color:#fff;padding:5px 10px;border-radius:5px;font-size:12px;z-index:3;transition:all .3s ease}
.controls{margin:0;display:flex;flex-direction:column;gap:20px;align-items:center;width:100%}
.control-panel{text-align:center;display:flex;flex-direction:column;justify-content:space-between;align-items:center;gap:15px;width:35%;flex-shrink:0;height:100%}

.result{position:relative;background:linear-gradient(135deg,#ff6b35 0%,#f7931e 100%);color:#fff;padding:25px;border-radius:15px;margin:25px 0;box-shadow:0 8px 25px rgba(255,107,53,.3);transition:all .3s ease;clear:both;overflow:hidden}
.result.actual{background:linear-gradient(135deg,#28a745 0%,#20c997 100%);box-shadow:0 8px 25px rgba(40,167,69,.3)}
.version-text{position:absolute;top:5px;right:10px;color:#fff;font-size:25px;font-weight:600}
.loading-overlay{position:absolute;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;border-radius:15px;z-index:5}
.loading-text{color:#fff;font-size:14px;font-weight:600;margin-top:10px;text-align:center}
.result-fields{display:flex;flex-direction:column;gap:15px}
.result-field{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.2);transition:all .3s ease}
.result-field:last-child{border-bottom:none}
.field-label{font-weight:600;font-size:12px;color:#fff;text-shadow:1px 1px 2px rgba(0,0,0,.3);transition:all .3s ease}
.field-value{font-size:12px;font-weight:700;color:#fff;text-shadow:1px 1px 2px rgba(0,0,0,.3);word-break:break-all;text-align:right;flex:1;margin-left:20px;transition:all .3s ease}

.status{margin:20px 0;font-style:italic;color:#666;font-size:1.1em;clear:both;transition:all .3s ease}
.zoom-controls{margin:0;text-align:center;transition:opacity .3s ease;overflow:hidden;flex:1;display:flex;flex-direction:column;justify-content:center;width:100%}
.zoom-label{margin-bottom:10px;font-weight:600;color:#333;font-size:1em}
.zoom-buttons{display:flex;flex-direction:column;justify-content:center;gap:8px;flex-wrap:nowrap;align-items:center;width:100%;margin:0 auto}
.zoom-btn{width:40px;height:40px;padding:0;font-size:18px;font-weight:bold;border-radius:8px;opacity:0.6;transition:all .2s ease;display:flex;align-items:center;justify-content:center;line-height:1;box-sizing:border-box;flex:0 0 40px;aspect-ratio:1/1;margin:1px 0}

/* Стили для кнопок в панели управления */
.control-panel .btn{transition:all .3s ease;border-radius:8px;font-weight:600;margin:2px 0}
.control-panel .btn:hover{transform:scale(1.02);box-shadow:0 4px 12px rgba(0,0,0,.15)}
.control-panel .btn:active{transform:scale(0.98)}
.control-panel .btn:focus{outline:2px solid #ff6b35;outline-offset:2px}
.zoom-btn:hover:not(:disabled){opacity:1;transform:scale(1.05)}
.zoom-btn:disabled{opacity:0.3;cursor:not-allowed}
.zoom-btn:focus{outline:2px solid #ff6b35;outline-offset:2px}

.error{color:#ff6b6b;background:rgba(255,107,53,.1);padding:15px;border-radius:10px;margin:15px 0;border:2px solid #ff6b6b;transition:all .3s ease}
.footer{margin-top:30px;font-size:.9em;color:#999;transition:all .3s ease}

/* PWA полноэкранный режим */
@media (display-mode: standalone) {
  body { padding: 0; }
  .container { border-radius: 0; max-width: 100%; }
  .scanner-wrapper { border-radius: 0; }
}

/* Скрытие системных элементов браузера */
@media (display-mode: standalone), (display-mode: minimal-ui) {
  body { 
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
  }
}




/* Основные стили для мобильных устройств - сохраняем двухколоночную структуру */
@media (max-width:480px){
  .container{padding:15px}
  .scanner-wrapper{display:flex;flex-direction:row;gap:12px;align-items:stretch}
  .scanner-container{width:65%;height:280px;min-width:180px}
  .scanner-frame{width:90%;height:120px}
  .control-panel{width:35%;min-width:100px;height:280px;display:flex;flex-direction:column;justify-content:space-between;align-items:center;gap:12px;padding:15px 0}
  .control-panel .logo{width:50px;height:50px;margin-bottom:8px;flex-shrink:0}
  .control-panel .btn{width:90% !important;height:40px !important;font-size:0.9em;max-width:90px;margin:3px 0;flex-shrink:0}
  .zoom-controls{width:90%;flex-shrink:0}
  .zoom-controls .zoom-buttons{flex-direction:column;gap:10px;width:100%}
  .zoom-controls .zoom-btn{width:100%;height:32px;font-size:14px;margin:2px 0;flex-shrink:0}
  .header h1{font-size:1.6em;margin-bottom:8px}
}

/* Стили для очень маленьких экранов */
@media (max-width:360px){
  .scanner-wrapper{gap:8px;align-items:stretch}
  .scanner-container{width:62%;min-width:160px}
  .control-panel{width:38%;min-width:90px;gap:8px;padding:10px 0}
  .control-panel .logo{width:45px;height:45px;margin-bottom:6px;flex-shrink:0}
  .control-panel .btn{width:85% !important;height:35px !important;font-size:0.8em;max-width:80px;margin:2px 0;flex-shrink:0}
  .zoom-controls{width:85%;flex-shrink:0}
  .zoom-controls .zoom-buttons{gap:8px}
  .zoom-controls .zoom-btn{height:28px;font-size:12px;margin:2px 0;flex-shrink:0}
}

/* Стили для планшетов и средних экранов */
@media (min-width:481px) and (max-width:768px){
  .scanner-wrapper{gap:20px;align-items:stretch}
  .scanner-container{width:65%}
  .control-panel{width:35%;gap:18px;padding:20px 0}
  .control-panel .logo{width:70px;height:70px;margin-bottom:12px;flex-shrink:0}
  .control-panel .btn{width:95% !important;max-width:120px;margin:3px 0;flex-shrink:0}
  .zoom-controls{width:95%;flex-shrink:0}
  .zoom-controls .zoom-buttons{gap:12px}
}

/* Обеспечиваем двухколоночную структуру для всех размеров экрана */
@media (max-width:600px){
  .scanner-wrapper{display:flex;flex-direction:row;align-items:stretch;gap:15px}
  .scanner-container{flex:1;min-width:0}
  .control-panel{flex-shrink:0;width:auto;min-width:120px;height:100%}
}

/* Дополнительные стили для лучшей адаптивности */
@media (max-width:400px){
  .container{padding:10px}
  .scanner-wrapper{gap:8px;align-items:stretch}
  .scanner-container{height:250px}
  .scanner-frame{width:85%;height:100px}
  .control-panel{height:250px;gap:10px;padding:12px 0}
  .control-panel .logo{width:45px;height:45px;margin-bottom:6px;flex-shrink:0}
  .control-panel .btn{width:85% !important;height:32px !important;font-size:0.8em;max-width:75px;margin:2px 0;flex-shrink:0}
  .zoom-controls{width:85%;flex-shrink:0}
  .zoom-controls .zoom-buttons{gap:8px}
  .zoom-controls .zoom-btn{height:24px;font-size:12px;margin:2px 0;flex-shrink:0}
}

/* Стили для ландшафтной ориентации на мобильных устройствах */
@media (max-width:768px) and (orientation: landscape){
  .scanner-wrapper{gap:15px;align-items:stretch}
  .scanner-container{height:200px}
  .control-panel{height:200px;gap:10px;padding:12px 0}
  .control-panel .logo{width:50px;height:50px;margin-bottom:8px;flex-shrink:0}
  .control-panel .btn{height:35px !important;flex-shrink:0}
  .zoom-controls{flex-shrink:0}
  .zoom-controls .zoom-btn{height:28px;flex-shrink:0}
}

/* Дополнительные стили для равномерного распределения элементов */
@media (max-width:480px){
  .control-panel .d-flex{justify-content:space-between;height:100%;padding:5px 0}
  .control-panel .logo{flex:0 0 auto}
  .control-panel .zoom-controls{flex:0 0 auto}
  .control-panel .btn{flex:0 0 auto}
}

@media (max-width:360px){
  .control-panel .d-flex{justify-content:space-between;height:100%;padding:3px 0}
}

/* Универсальные стили для всех мобильных устройств */
@media (max-width:768px){
  /* Базовые настройки для всех мобильных устройств */
  .scanner-wrapper{display:flex;flex-direction:row;align-items:stretch;gap:clamp(8px, 2vw, 20px)}
  .scanner-container{flex:1;min-width:0;height:clamp(250px, 60vh, 400px)}
  .control-panel{flex-shrink:0;width:clamp(100px, 35vw, 150px);height:100%;display:flex;flex-direction:column;justify-content:space-between;align-items:center;gap:clamp(8px, 2vh, 15px);padding:clamp(8px, 2vh, 15px) 0}
  
  /* Адаптивные размеры логотипа */
  .control-panel .logo{width:clamp(45px, 12vw, 80px);height:clamp(45px, 12vw, 80px);flex-shrink:0;margin-bottom:clamp(4px, 1vh, 8px)}
  
  /* Адаптивные размеры кнопок */
  .control-panel .btn{width:clamp(80px, 90%, 130px) !important;height:clamp(35px, 8vh, 50px) !important;font-size:clamp(0.8em, 2.5vw, 1em);flex-shrink:0;margin:clamp(1px, 0.5vh, 3px) 0}
  
  /* Адаптивные размеры элементов управления приближением */
  .zoom-controls{width:clamp(80px, 90%, 130px);flex-shrink:0}
  .zoom-controls .zoom-buttons{flex-direction:column;gap:clamp(6px, 1.5vh, 10px);width:100%}
  .zoom-controls .zoom-btn{width:100%;height:clamp(24px, 6vh, 40px);font-size:clamp(12px, 3vw, 18px);flex-shrink:0;margin:clamp(1px, 0.5vh, 2px) 0}
}

/* Специальные стили для очень маленьких экранов */
@media (max-width:320px){
  .scanner-wrapper{gap:6px}
  .control-panel{width:clamp(80px, 38vw, 100px);gap:6px;padding:6px 0}
  .control-panel .logo{width:40px;height:40px;margin-bottom:4px}
  .control-panel .btn{height:32px !important;font-size:0.75em}
  .zoom-controls .zoom-btn{height:22px;font-size:11px}
}

/* Специальные стили для средних мобильных экранов */
@media (min-width:321px) and (max-width:480px){
  .scanner-wrapper{gap:clamp(10px, 2.5vw, 15px)}
  .control-panel{width:clamp(110px, 35vw, 140px);gap:clamp(10px, 2.5vh, 15px);padding:clamp(10px, 2.5vh, 15px) 0}
  .control-panel .logo{width:clamp(50px, 13vw, 70px);height:clamp(50px, 13vw, 70px);margin-bottom:clamp(6px, 1.5vh, 10px)}
  .control-panel .btn{height:clamp(38px, 9vh, 45px) !important;font-size:clamp(0.85em, 2.8vw, 0.95em)}
  .zoom-controls .zoom-btn{height:clamp(28px, 7vh, 35px);font-size:clamp(13px, 3.5vw, 16px)}
}

/* Специальные стили для больших мобильных экранов и планшетов */
@media (min-width:481px) and (max-width:768px){
  .scanner-wrapper{gap:clamp(15px, 3vw, 25px)}
  .control-panel{width:clamp(130px, 35vw, 160px);gap:clamp(15px, 3vh, 20px);padding:clamp(15px, 3vh, 20px) 0}
  .control-panel .logo{width:clamp(60px, 15vw, 80px);height:clamp(60px, 15vw, 80px);margin-bottom:clamp(8px, 2vh, 12px)}
  .control-panel .btn{height:clamp(42px, 10vh, 50px) !important;font-size:clamp(0.9em, 3vw, 1em)}
  .zoom-controls .zoom-btn{height:clamp(32px, 8vh, 40px);font-size:clamp(14px, 4vw, 18px)}
}

/* Стили для обеспечения совместимости с разными браузерами */
@supports not (gap: clamp(8px, 2vw, 20px)){
  @media (max-width:768px){
    .scanner-wrapper{gap:15px}
    .control-panel{gap:12px;padding:12px 0}
    .control-panel .logo{margin-bottom:6px}
    .control-panel .btn{margin:2px 0}
    .zoom-controls .zoom-buttons{gap:8px}
    .zoom-controls .zoom-btn{margin:1px 0}
  }
}

/* Стили для устройств с высоким DPI */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi){
  .control-panel .btn{font-weight:500}
  .zoom-controls .zoom-btn{font-weight:600}
}

/* Стили для устройств с низким DPI */
@media (-webkit-max-device-pixel-ratio: 1), (max-resolution: 96dpi){
  .control-panel .btn{font-weight:600}
  .zoom-controls .zoom-btn{font-weight:700}
}

/* Стили для устройств с сенсорным экраном */
@media (hover: none) and (pointer: coarse){
  .control-panel .btn{min-height:44px;min-width:44px}
  .zoom-controls .zoom-btn{min-height:32px;min-width:32px}
  .control-panel .logo{min-height:48px;min-width:48px}
}

/* Стили для устройств без сенсорного экрана */
@media (hover: hover) and (pointer: fine){
  .control-panel .btn:hover{transform:scale(1.02)}
  .zoom-controls .zoom-btn:hover{opacity:1}
}

/* Стили для портретной ориентации на мобильных устройствах */
@media (max-width:768px) and (orientation: portrait){
  .scanner-container{height:clamp(280px, 70vh, 400px)}
  .control-panel{height:100%;gap:clamp(10px, 2.5vh, 18px)}
}

/* Стили для ландшафтной ориентации на мобильных устройствах */
@media (max-width:768px) and (orientation: landscape){
  .scanner-container{height:clamp(200px, 50vh, 300px)}
  .control-panel{height:100%;gap:clamp(8px, 2vh, 15px)}
  .control-panel .logo{width:clamp(40px, 10vw, 60px);height:clamp(40px, 10vw, 60px)}
  .control-panel .btn{height:clamp(32px, 7vh, 40px) !important}
  .zoom-controls .zoom-btn{height:clamp(24px, 6vh, 32px)}
}

/* Стили для очень широких экранов (планшеты в альбомной ориентации) */
@media (min-width:769px) and (max-width:1024px){
  .scanner-wrapper{gap:clamp(20px, 4vw, 30px)}
  .scanner-container{width:65%;height:clamp(350px, 80vh, 450px)}
  .control-panel{width:35%;gap:clamp(18px, 3vh, 25px);padding:clamp(20px, 4vh, 30px) 0}
  .control-panel .logo{width:clamp(70px, 18vw, 90px);height:clamp(70px, 18vw, 90px)}
  .control-panel .btn{width:clamp(120px, 95%, 150px) !important;height:clamp(45px, 10vh, 55px) !important}
  .zoom-controls{width:clamp(120px, 95%, 150px)}
  .zoom-controls .zoom-btn{height:clamp(36px, 8vh, 44px)}
}

/* Стили для устройств с нестандартными размерами viewport */
@media (max-width:768px) and (max-height:500px){
  .scanner-container{height:clamp(180px, 45vh, 250px)}
  .control-panel{gap:clamp(6px, 1.5vh, 12px);padding:clamp(6px, 1.5vh, 12px) 0}
  .control-panel .logo{width:clamp(35px, 9vw, 50px);height:clamp(35px, 9vw, 50px)}
  .control-panel .btn{height:clamp(28px, 6vh, 35px) !important}
  .zoom-controls .zoom-btn{height:clamp(20px, 5vh, 28px)}
}

@media (max-width:768px) and (min-height:800px){
  .scanner-container{height:clamp(350px, 75vh, 450px)}
  .control-panel{gap:clamp(15px, 3vh, 20px);padding:clamp(15px, 3vh, 20px) 0}
  .control-panel .logo{width:clamp(55px, 14vw, 75px);height:clamp(55px, 14vw, 75px)}
  .control-panel .btn{height:clamp(42px, 9vh, 50px) !important}
  .zoom-controls .zoom-btn{height:clamp(30px, 7vh, 38px)}
}

/* Стили для устройств с очень узкими экранами */
@media (max-width:280px){
  .scanner-wrapper{gap:4px}
  .scanner-container{width:60%;min-width:120px}
  .control-panel{width:40%;min-width:70px;gap:4px;padding:4px 0}
  .control-panel .logo{width:35px;height:35px;margin-bottom:3px}
  .control-panel .btn{width:100% !important;height:30px !important;font-size:0.7em}
  .zoom-controls{width:100%}
  .zoom-controls .zoom-btn{height:20px;font-size:10px}
}

/* Специальные стили для Android устройств */
@media screen and (-webkit-min-device-pixel-ratio: 1) {
  /* Улучшение отображения логотипа на Android */
  .control-panel .logo img{
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
  }
}

/* Специальные стили для Android Chrome */
@media screen and (-webkit-min-device-pixel-ratio: 1) and (max-width:768px) {
  .control-panel .logo{
    -webkit-transform: translate3d(0,0,0);
    transform: translate3d(0,0,0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    -webkit-perspective: 1000;
    perspective: 1000;
  }
  
  .control-panel .logo img{
    -webkit-transform: translate3d(0,0,0);
    transform: translate3d(0,0,0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
    -webkit-filter: contrast(1.1) brightness(1.05);
    filter: contrast(1.1) brightness(1.05);
  }
}

/* Специальные стили для Android WebView */
@media screen and (max-width:768px) {
  .control-panel .logo{
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
  }
  
  .control-panel .logo img{
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
  }
}

/* Дополнительные стили для улучшения логотипа на Android */
@media screen and (max-width:768px) {
  .control-panel .logo{
    /* Улучшение рендеринга на Android */
    -webkit-transform: translate3d(0,0,0);
    transform: translate3d(0,0,0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    -webkit-perspective: 1000;
    perspective: 1000;
    /* Предотвращение размытия */
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    /* Улучшение четкости */
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
    image-rendering: pixelated;
  }
  
  .control-panel .logo img{
    /* Принудительное включение аппаратного ускорения */
    -webkit-transform: translate3d(0,0,0);
    transform: translate3d(0,0,0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    /* Улучшение качества изображения */
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
    image-rendering: pixelated;
    /* Фильтры для улучшения четкости */
    -webkit-filter: contrast(1.1) brightness(1.05) saturate(1.1);
    filter: contrast(1.1) brightness(1.05) saturate(1.1);
    /* Предотвращение размытия */
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
}

/* Специальные стили для Android с высоким DPI */
@media screen and (-webkit-min-device-pixel-ratio: 2) and (max-width:768px) {
  .control-panel .logo img{
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
    -webkit-filter: contrast(1.2) brightness(1.1) saturate(1.2);
    filter: contrast(1.2) brightness(1.1) saturate(1.2);
  }
}

/* Специальные стили для Android с низким DPI */
@media screen and (-webkit-max-device-pixel-ratio: 1) and (max-width:768px) {
  .control-panel .logo img{
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
    -webkit-filter: contrast(1.05) brightness(1.02) saturate(1.05);
    filter: contrast(1.05) brightness(1.02) saturate(1.05);
  }
}

/* Стили для результата на мобильных устройствах */
@media (max-width:480px){
  .result{padding:20px;margin:20px 0}
  .result-fields{gap:12px}
  .result-field{padding:10px 0}
  .field-label{font-size:11px}
  .field-value{font-size:11px;margin-left:15px}
  .version-text{font-size:20px}
}

@media (max-width:360px){
  .result{padding:15px;margin:15px 0}
  .result-fields{gap:10px}
  .result-field{padding:8px 0}
  .field-label{font-size:10px}
  .field-value{font-size:10px;margin-left:10px}
  .version-text{font-size:18px}
}

/* Стили для меню навигации на мобильных устройствах */
@media (max-width:480px){
  .navigation-menu{padding:15px}
  .menu-header{margin-bottom:30px}
  .menu-header .logo{width:60px;height:60px;margin:0 auto 15px}
  .menu-items{gap:10px;max-width:300px}
  .menu-item{padding:15px 20px;font-size:14px}
}

@media (max-width:360px){
  .navigation-menu{padding:10px}
  .menu-header{margin-bottom:25px}
  .menu-header .logo{width:50px;height:50px;margin:0 auto 12px}
  .menu-items{gap:8px;max-width:280px}
  .menu-item{padding:12px 18px;font-size:13px}
}

/* Стили для footer и статуса на мобильных устройствах */
@media (max-width:480px){
  .footer{margin-top:20px}
  .status{font-size:1em;margin:15px 0}
  #pwa-indicator{font-size:0.75em;margin-top:8px}
}

@media (max-width:360px){
  .footer{margin-top:15px}
  .status{font-size:0.9em;margin:12px 0}
  #pwa-indicator{font-size:0.7em;margin-top:6px}
}

/* Стили для ошибок на мобильных устройствах */
@media (max-width:480px){
  .error{padding:12px;margin:12px 0;font-size:0.9em}
}

@media (max-width:360px){
  .error{padding:10px;margin:10px 0;font-size:0.85em}
}

/* Стили для индикатора загрузки на мобильных устройствах */
@media (max-width:480px){
  .loading-overlay{padding:20px}
  .loading-text{font-size:13px;margin-top:8px}
}

@media (max-width:360px){
  .loading-overlay{padding:15px}
  .loading-text{font-size:12px;margin-top:6px}
}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="scanner-wrapper">
                <div class="scanner-container" id="scannerRoot">
                    <div class="scanner-frame">
                        <div class="scanner-line"></div>
                    </div>
                    <div id="scannerStatus" class="scan-status" style="display:none;">🔍 Сканирование...</div>
                </div>
                <div class="control-panel">
                    <div class="d-flex flex-column align-items-center gap-md-1 gap-lg-3">
                        <button class="logo-btn logo" style="width: 130px; height: 120px;" id="logoBtn">
                            <img src="scannerlogo.png" alt="Logo">
                        </button>
                        <div class="zoom-controls">
                            <div class="zoom-buttons">
                                <button
                                    class="btn btn-outline-secondary btn-hover"
                                    style="width: 130px; height: 50px;"
                                    id="zoomMinus"
                                    disabled
                                >−</button>
                                <button
                                    class="btn btn-outline-secondary btn-hover"
                                    style="width: 130px; height: 50px;"
                                    id="zoomPlus"
                                    disabled
                                >+</button>
                            </div>
                        </div>
                        <button id="startBtn" class="btn btn-success" style="width: 130px; height: 50px;">пуск</button>
                        <button
                            id="stopBtn"
                            class="btn btn-secondary"
                            style="width: 130px; height: 50px;"
                            disabled
                        >стоп</button>
                    </div>
                </div>
            </div>
            <div class="result">
                <div class="result-fields">
                    <div class="result-field">
                        <span class="field-label">Штрих-код:</span>
                        <span class="field-value" id="barcodeValue"></span>
                    </div>
                    <div class="result-field">
                        <span class="field-label">Обозначение:</span>
                        <span class="field-value" id="designationValue">—</span>
                    </div>
                    <div class="result-field">
                        <span class="field-label">Наименование:</span>
                        <span class="field-value" id="nameValue">—</span>
                    </div>
                    <div class="result-field">
                        <span class="field-label">Автор:</span>
                        <span class="field-value" id="authorValue">—</span>
                    </div>
                    <div class="result-field">
                        <span class="field-label">Дата публикации:</span>
                        <span class="field-value" id="dateValue">—</span>
                    </div>
                </div>
                <div id="versionIndicator" class="version-text" style="display: none;">Версия актуальна</div>
                <!-- Индикатор загрузки -->
                <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                    <div class="loading-text">Обработка результата...</div>
                </div>
            </div>
            <div id="error" class="error" style="display:none"></div>
            <!-- Меню навигации -->
            <div id="navigationMenu" class="navigation-menu" style="display: none;">
                <div class="menu-header">
                    <button class="logo logo-btn" id="menuLogoBtn">
                        <img src="scannerlogo.png" alt="Logo">
                    </button>
                </div>
                <div class="menu-items">
                    <button class="menu-item menu-item-scan">📱 Сканирование ШК</button>
                    <button class="menu-item menu-item-manual">✏️ Ввод ШК вручную</button>
                    <button class="menu-item menu-item-auth">🔐 Авторизация</button>
                    <button class="menu-item menu-item-list">📋 Получить список запрошенных ШК</button>
                    <button class="menu-item menu-item-support">💬 Написать в поддержку</button>
                    <button class="menu-item menu-item-info">ℹ️ Информация</button>
                </div>
            </div>
            <div class="footer">
                <div class="status" id="status">Камера не активирована</div>
                <div id="pwa-indicator" style="margin-top:10px;font-size:.8em;color:#666;"></div>
            </div>
        </div>
        <!-- ZXing-CPP (WASM) -->
        <script src="https://cdn.jsdelivr.net/npm/zxing-wasm@2/dist/iife/reader/index.js"></script>
        <!-- Quagga2 как финальный фолбэк -->
        <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.1/dist/quagga.min.js"></script>
        <script>
// PWA полноэкранный режим
function enableFullscreen() {
  if (document.documentElement.requestFullscreen) {
    document.documentElement.requestFullscreen();
  } else if (document.documentElement.webkitRequestFullscreen) {
    document.documentElement.webkitRequestFullscreen();
  } else if (document.documentElement.msRequestFullscreen) {
    document.documentElement.msRequestFullscreen();
  }
}

// Автоматическое включение полноэкранного режима для PWA
if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(enableFullscreen, 1000);
  });
}

// Специальные функции для улучшения отображения на Android
function optimizeForAndroid() {
  // Определяем Android устройство
  const isAndroid = /Android/i.test(navigator.userAgent);
  const isChrome = /Chrome/i.test(navigator.userAgent);
  const isWebView = /wv/i.test(navigator.userAgent);
  
  if (isAndroid) {
    console.log('Android устройство обнаружено, применяем оптимизации...');
    
    // Принудительное включение аппаратного ускорения для логотипа
    const logoElements = document.querySelectorAll('.control-panel .logo, .control-panel .logo img');
    logoElements.forEach(element => {
      element.style.webkitTransform = 'translate3d(0,0,0)';
      element.style.transform = 'translate3d(0,0,0)';
      element.style.webkitBackfaceVisibility = 'hidden';
      element.style.backfaceVisibility = 'hidden';
      element.style.webkitPerspective = '1000px';
      element.style.perspective = '1000px';
    });
    
    // Улучшение качества изображений на Android
    if (isChrome || isWebView) {
      const images = document.querySelectorAll('.control-panel .logo img');
      images.forEach(img => {
        img.style.imageRendering = 'crisp-edges';
        img.style.webkitImageRendering = 'crisp-edges';
        img.style.imageRendering = 'pixelated';
        
        // Применяем фильтры для улучшения четкости
        img.style.webkitFilter = 'contrast(1.1) brightness(1.05) saturate(1.1)';
        img.style.filter = 'contrast(1.1) brightness(1.05) saturate(1.1)';
      });
    }
    
    // Специальные настройки для Android WebView
    if (isWebView) {
      document.body.style.webkitFontSmoothing = 'antialiased';
      document.body.style.mozOsxFontSmoothing = 'grayscale';
    }
  }
}

class BarcodeScanner {
  constructor(){
    this.startBtn = document.getElementById("startBtn");
    this.stopBtn = document.getElementById("stopBtn");
    this.resultText = document.getElementById("resultText");
    this.status = document.getElementById("status");
    this.error = document.getElementById("error");
    this.scannerRoot = document.getElementById("scannerRoot");
    this.frameEl = document.querySelector(".scanner-frame");

    this.isScanning = false;
    this.engine = null; // 'native' | 'zxing' | 'quagga'
    this.videoEl = null;
    this.mediaStream = null;
    this.videoTrack = null;
    this.zoomControls = null;
    this.currentZoom = 1;

    // анти-дребезг
    this.lastCode = null;
    this.candidate = null;
    this.candidateCount = 0;
    this.candidateFirstAt = 0;
    this.lockedUntil = 0;
    this.EMIT_STABLE_FRAMES = 4;
    this.EMIT_STABLE_SAME_MS = 400;
    this.EMIT_COOLDOWN_MS = 1200;
    this.PROCESSING_TIME_MS = 2500; // Время обработки результата

    this.noDetectionTimer = null;
    this.NO_DETECTION_MS = 8000;
    this.isProcessing = false; // Флаг обработки результата

    this._rafId = 0;

    this.startScanner = this.startScanner.bind(this);
    this.stopScanner = this.stopScanner.bind(this);
    this._onResize = this._onResize.bind(this);
    this.toggleMenu = this.toggleMenu.bind(this);
  }

  initialize(){
    this.startBtn.addEventListener("click", this.startScanner);
    this.stopBtn.addEventListener("click", this.stopScanner);
    window.addEventListener("resize", this._onResize);
    
    // Инициализация элементов управления приближением
    this.zoomControls = document.querySelector('.zoom-controls');
    this._setupZoomControls();
    
    // Инициализация кнопки логотипа
    const logoBtn = document.getElementById('logoBtn');
    const menuLogoBtn = document.getElementById('menuLogoBtn');
    if (logoBtn) logoBtn.addEventListener('click', this.toggleMenu);
    if (menuLogoBtn) menuLogoBtn.addEventListener('click', this.toggleMenu);
  }

  async startScanner(){
    this._showError("");
    this.status.textContent = "Запрос доступа к камере...";
    try{
      if (await this._canUseNative()) {
        await this._startCamera();
        this.engine = 'native';
        this._scanNative();
      } else if (window.ZXingWASM) {
        await this._startCamera();
        this.engine = 'zxing';
        await ZXingWASM.readBarcodes(new ImageData(1,1), { formats: ["Code39"] }); // прогрев
        this._scanZXing();
      } else {
        await this._startQuagga();
        this.engine = 'quagga';
      }

      this.isScanning = true;
      this.startBtn.disabled = true;
      this.startBtn.classList.remove('btn-success');
      this.startBtn.classList.add('btn-secondary');
      this.stopBtn.disabled = false;
      this.stopBtn.classList.remove('btn-secondary');
      this.stopBtn.classList.add('btn-danger');
      this.status.textContent = "Сканер готов! Наведите на штрих-код ScannerOGP (1×)";
      this.frameEl.style.display = "block";
      
              // Проверяем поддержку приближения и активируем кнопки только если нужно
        if (this.zoomControls) {
          // Сначала отключаем кнопки zoom
          this._disableZoomControls();
          // Проверяем поддержку приближения после запуска камеры
          setTimeout(() => {
            if (this._checkZoomSupport()) {
              // Кнопки уже включены в _checkZoomSupport
            } else {
              // Обновляем статус, если zoom не поддерживается
              if (this.status.textContent.includes('(1×)')) {
                this.status.textContent = "Сканер готов! Наведите на штрих-код ScannerOGP";
              }
            }
          }, 800);
        }
      
      this._resetNoDetectionTimer();
    } catch(e){
      this._handleError("Ошибка запуска: " + (e?.message || e));
    }
  }

  async _canUseNative(){
    if (!('BarcodeDetector' in window)) return false;
    try{
      const formats = await BarcodeDetector.getSupportedFormats();
      return formats.includes('code_39');
    }catch{ return false; }
  }

  async _startCamera(){
    if (!this.videoEl){
      this.videoEl = document.createElement("video");
      this.videoEl.setAttribute("playsinline","true");
      this.videoEl.autoplay = true;
      this.videoEl.muted = true;
      this.scannerRoot.appendChild(this.videoEl);
    }
    this.mediaStream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: "environment" },
        width: { ideal: 1920 }, height: { ideal: 1080 },
        advanced: [{ focusMode: "continuous" }]
      },
      audio: false
    });
    this.videoEl.srcObject = this.mediaStream;
    this.videoTrack = this.mediaStream.getVideoTracks()[0] || null;
    await this._applyAutoFocus();
  }

  // ======= Native (BarcodeDetector) =======
  // Используем нативный API браузера для лучшей производительности
  async _scanNative(){
    const detector = new BarcodeDetector({ formats: ['code_39'] });
    const loop = async ()=>{
      if (!this.isScanning || this.engine!=='native') return;
      try{
        const res = await detector.detect(this.videoEl);
        if (res && res.length) this._onCandidate(res[0].rawValue);
      }catch{}
      this._resetNoDetectionTimer();
      this._rafId = requestAnimationFrame(loop);
    };
    this._rafId = requestAnimationFrame(loop);
  }

  // ======= ZXing-WASM =======
  // Fallback для браузеров без нативного BarcodeDetector
  // Пользователи могут использовать жесты приближения на своих устройствах
  async _scanZXing(){
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    const opts = {
      formats: ["Code39"],
      tryHarder: true,
      tryRotate: true,
      tryInvert: true,
      tryDownscale: true,
      minLineCount: 2,
      maxNumberOfSymbols: 1,
      tryCode39ExtendedMode: true,
      binarizer: "LocalAverage"
    };

    const loop = async ()=>{
      if (!this.isScanning || this.engine!=='zxing') return;
      try{
        const { w, h } = this._drawROIToCanvas(this.videoEl, canvas, ctx);
        const imageData = ctx.getImageData(0,0,w,h);
        const results = await ZXingWASM.readBarcodes(imageData, opts);
        if (results && results.length) this._onCandidate(results[0].text);
      }catch{}
      this._resetNoDetectionTimer();
      this._rafId = requestAnimationFrame(loop);
    };
    this._rafId = requestAnimationFrame(loop);
  }

  _drawROIToCanvas(video, canvas, ctx){
    const vr = video.getBoundingClientRect();
    const fr = this.frameEl.getBoundingClientRect();
    const sx = Math.max(0, (fr.left - vr.left) / vr.width  * video.videoWidth);
    const sy = Math.max(0, (fr.top  - vr.top ) / vr.height * video.videoHeight);
    const sw = Math.min(video.videoWidth  - sx, fr.width  / vr.width  * video.videoWidth);
    const sh = Math.min(video.videoHeight - sy, fr.height / vr.height * video.videoHeight);
    const w = Math.max(360, Math.floor(sw));
    const h = Math.max(160, Math.floor(sh));
    canvas.width = w; canvas.height = h;
    ctx.drawImage(video, sx, sy, sw, sh, 0, 0, w, h);
    return { w, h };
  }

  // ======= Quagga2 (fallback) =======
  async _startQuagga(){
    return new Promise((resolve,reject)=>{
      try{ Quagga.offDetected?.(()=>{}); }catch(_){}
      const area = this._computeROI();
      const constraints = {
        facingMode: { ideal: "environment" },
        width:{ideal:1920}, height:{ideal:1080},
        advanced:[{ focusMode: "continuous" }]
      };
      Quagga.init({
        inputStream:{ name:"Live", type:"LiveStream", target:this.scannerRoot, constraints, area },
        locator:{ patchSize:"x-small", halfSample:false },
        decoder:{ readers:["code_39_reader"], multiple:false },
        locate:true,
        numOfWorkers: navigator.hardwareConcurrency || 4,
        frequency: 25
      }, (err)=>{
        if (err) return reject(err);
        Quagga.onDetected((res)=>{
          const code = res?.codeResult?.code;
          if (code) this._onCandidate(code);
          this._resetNoDetectionTimer();
        });
        Quagga.start();

        setTimeout(async ()=>{
          const v = this.scannerRoot.querySelector("video");
          if (v){ v.setAttribute("playsinline",""); v.muted = true; v.autoplay = true; }
          this.videoEl = v;
          this.mediaStream = v?.srcObject || null;
          this.videoTrack = this.mediaStream?.getVideoTracks?.()[0] || null;
          await this._applyAutoFocus();
        }, 300);

        this._resetNoDetectionTimer();
        resolve();
      });
    });
  }

  _computeROI(){
    const r = this.scannerRoot.getBoundingClientRect();
    const f = this.frameEl.getBoundingClientRect();
    const top = Math.max(0, (f.top - r.top)/r.height*100);
    const left= Math.max(0, (f.left- r.left)/r.width *100);
    const right = Math.max(0, 100 - (f.right - r.left)/r.width *100);
    const bottom= Math.max(0, 100 - (f.bottom- r.top )/r.height*100);
    return { top:`${top}%`, right:`${right}%`, left:`${left}%`, bottom:`${bottom}%` };
  }

  _onCandidate(raw){
    const now = performance.now();
    if (now < this.lockedUntil || this.isProcessing) return; // Блокируем во время обработки

    let code = (raw || "").trim().replace(/^\*|\*$/g, "");
    if (!code) return;

    if (this.candidate === code){
      this.candidateCount++;
    } else {
      this.candidate = code;
      this.candidateCount = 1;
      this.candidateFirstAt = now;
    }

    const longEnough = (now - this.candidateFirstAt) >= this.EMIT_STABLE_SAME_MS;
    if (this.candidateCount >= this.EMIT_STABLE_FRAMES && longEnough){
      this._emitFinal(code);
    }
  }

  _emitFinal(code){
    this.lastCode = code;
    
    // Блокируем новые сканирования
    this.isProcessing = true;
    
    // Показываем индикатор загрузки
    this._showLoadingOverlay();
    
    // Обновляем поле штрих-кода
    const barcodeValue = document.getElementById('barcodeValue');
    if (barcodeValue) {
      barcodeValue.textContent = code;
    }
    
    // Заполняем остальные поля данными при успешном сканировании
    this._fillResultFields(code);
    
    // Проверяем актуальность версии и обновляем цвет рамки
    this._checkVersionAndUpdateUI(code);
    
    this.status.textContent = `Готово: ${code} (${this.currentZoom}×)`;
    this._flashFrame(true);
    this._beep();
    setTimeout(()=> this._flashFrame(false), 900);
    
    // Запускаем таймер обработки
    setTimeout(() => {
      this._hideLoadingOverlay();
      this.isProcessing = false;
    }, this.PROCESSING_TIME_MS);
    
    this.lockedUntil = performance.now() + this.EMIT_COOLDOWN_MS;
    this.candidate = null;
    this.candidateCount = 0;
    this.candidateFirstAt = 0;
  }

  async _applyAutoFocus(){
    if (!this.videoTrack?.getCapabilities) return;
    const caps = this.videoTrack.getCapabilities();
    const adv = [];
    
    // Только автофокус - убираем автоматическое приближение
    // Пользователи сами выберут нужное приближение на своих устройствах
    if (caps.focusMode?.includes?.("continuous")) {
      adv.push({ focusMode: "continuous" });
    }
    
    // Применяем только настройки фокуса
    if (adv.length > 0) {
      try {
        await this.videoTrack.applyConstraints({ advanced: adv });
      } catch (e) {
        console.log('Не удалось применить автофокус:', e);
      }
    }
  }

  _setupZoomControls(){
    if (!this.zoomControls) return;
    
    // Настройка кнопок + и - (проверка zoom будет позже при запуске камеры)
    const zoomPlus = document.getElementById('zoomPlus');
    const zoomMinus = document.getElementById('zoomMinus');
    
    if (zoomPlus && zoomMinus) {
      zoomPlus.addEventListener('click', () => this._stepZoom(1));
      zoomMinus.addEventListener('click', () => this._stepZoom(-1));
    }
  }

  _checkZoomSupport(){
    // Проверяем поддержку приближения при запуске камеры
    if (this.videoTrack?.getCapabilities) {
      const caps = this.videoTrack.getCapabilities();
      
      // Логируем информацию о возможностях камеры
      console.log('Возможности камеры:', {
        zoom: caps.zoom,
        focusMode: caps.focusMode,
        torch: caps.torch
      });
      
      // Проверяем, поддерживает ли устройство приближение
      if (!caps.zoom || caps.zoom.min === caps.zoom.max || caps.zoom.max <= 1.1) {
        console.log('Устройство не поддерживает приближение');
        this._disableZoomControls();
        return false;
      }
      
      // Показываем только доступные значения zoom
      const min = Math.ceil(caps.zoom.min ?? 1);
      const max = Math.floor(caps.zoom.max ?? 1);
      
      console.log(`Доступный диапазон zoom: ${min}x - ${max}x`);
      
      // Если максимальное приближение меньше 1.3, то zoom не нужен
      // (некоторые веб-камеры имеют очень маленький диапазон)
      if (max < 1.3) {
        console.log('Максимальное приближение слишком мало, zoom не нужен');
        this._disableZoomControls();
        return false;
      }
      
      console.log('Кнопки приближения активированы');
      this._enableZoomControls();
      return true;
    }
    
    console.log('Не удалось получить возможности камеры');
    this._disableZoomControls();
    return false;
  }

  async _applyZoom(zoom){
    if (!this.videoTrack?.getCapabilities) return;
    
    try {
      const caps = this.videoTrack.getCapabilities();
      if (!caps.zoom) return;
      
      const min = caps.zoom.min ?? 1;
      const max = caps.zoom.max ?? 1;
      
      // Ограничиваем приближение доступными значениями
      const clampedZoom = Math.max(min, Math.min(max, zoom));
      
      await this.videoTrack.applyConstraints({
        advanced: [{ zoom: clampedZoom }]
      });
      
      this.currentZoom = clampedZoom;
      console.log(`Приближение установлено: ${clampedZoom}x`);
      
      // Обновляем статус с информацией о приближении
      if (this.status.textContent.includes('Готово:')) {
        this.status.textContent = `Готово: ${this.lastCode} (${clampedZoom}×)`;
      }
      
      // Короткий звуковой сигнал при изменении приближения
      this._beepShort();
      
    } catch (e) {
      console.log('Не удалось применить приближение:', e);
      // Показываем ошибку пользователю
      this._handleError(`Не удалось установить приближение ${zoom}×`);
    }
  }

  _enableZoomControls(){
    // Включаем кнопки zoom
    if (this.zoomControls) {
      const zoomMinus = document.getElementById('zoomMinus');
      const zoomPlus = document.getElementById('zoomPlus');
      if (zoomMinus && zoomPlus) {
        zoomMinus.disabled = false;
        zoomPlus.disabled = false;
        zoomMinus.classList.remove('btn-outline-secondary');
        zoomMinus.classList.add('btn-outline-primary');
        zoomPlus.classList.remove('btn-outline-secondary');
        zoomPlus.classList.add('btn-outline-primary');
      }
    }
  }

  _disableZoomControls(){
    // Отключаем кнопки zoom
    if (this.zoomControls) {
      const zoomMinus = document.getElementById('zoomMinus');
      const zoomPlus = document.getElementById('zoomPlus');
      if (zoomMinus && zoomPlus) {
        zoomMinus.disabled = true;
        zoomPlus.disabled = true;
        zoomMinus.classList.remove('btn-outline-primary');
        zoomMinus.classList.add('btn-outline-secondary');
        zoomPlus.classList.remove('btn-outline-primary');
        zoomPlus.classList.add('btn-outline-secondary');
      }
    }
  }

  _stepZoom(step){
    if (!this.videoTrack?.getCapabilities) return;
    
    const caps = this.videoTrack.getCapabilities();
    if (!caps.zoom) return;
    
    const min = Math.ceil(caps.zoom.min ?? 1);
    const max = Math.floor(caps.zoom.max ?? 1);
    
    // Находим следующее доступное значение зума
    const availableZooms = [1, 2, 3, 4, 5].filter(z => z >= min && z <= max);
    if (availableZooms.length === 0) return;
    
    const currentIndex = availableZooms.indexOf(this.currentZoom);
    let newIndex;
    
    if (step > 0) {
      // Увеличиваем зум
      newIndex = Math.min(currentIndex + 1, availableZooms.length - 1);
    } else {
      // Уменьшаем зум
      newIndex = Math.max(currentIndex - 1, 0);
    }
    
    const newZoom = availableZooms[newIndex];
    if (newZoom !== this.currentZoom) {
      // Применяем приближение
      this._applyZoom(newZoom);
    }
  }

  _checkVersionAndUpdateUI(code){
    // Получаем элемент результата и индикатор
    const resultElement = document.querySelector('.result');
    const versionIndicator = document.getElementById('versionIndicator');
    
    if (!resultElement || !versionIndicator) return;
    
    // Здесь можно добавить логику проверки актуальности версии
    // Пока что используем простую проверку по длине кода
    const isActual = code.length >= 5; // Пример: код длиной 5+ символов считается актуальным
    
    if (isActual) {
      // Версия актуальна - зеленый цвет рамки и показываем индикатор
      resultElement.classList.add('actual');
      versionIndicator.style.display = 'block';
    } else {
      // Версия не актуальна - оранжевый цвет рамки и скрываем индикатор
      resultElement.classList.remove('actual');
      versionIndicator.style.display = 'none';
    }
  }

  _fillResultFields(code){
    // Заполняем поля результата данными при успешном сканировании
    const designationValue = document.getElementById('designationValue');
    const nameValue = document.getElementById('nameValue');
    const authorValue = document.getElementById('authorValue');
    const dateValue = document.getElementById('dateValue');
    
    if (designationValue) designationValue.textContent = '073Д-П-ЭЭ';
    if (nameValue) nameValue.textContent = 'Текстовая часть';
    if (authorValue) authorValue.textContent = 'Чернов Юрий';
    if (dateValue) dateValue.textContent = '10.26.2015 16:39:23';
  }

  _clearResultFields(){
    // Очищаем все поля результата
    const barcodeValue = document.getElementById('barcodeValue');
    const designationValue = document.getElementById('designationValue');
    const nameValue = document.getElementById('nameValue');
    const authorValue = document.getElementById('authorValue');
    const dateValue = document.getElementById('dateValue');
    
    if (barcodeValue) barcodeValue.textContent = ' ';
    if (designationValue) designationValue.textContent = '—';
    if (nameValue) nameValue.textContent = '—';
    if (authorValue) authorValue.textContent = '—';
    if (dateValue) dateValue.textContent = '—';
  }

  _showLoadingOverlay(){
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
      loadingOverlay.style.display = 'flex';
    }
  }

  _hideLoadingOverlay(){
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
      loadingOverlay.style.display = 'none';
    }
  }

  toggleMenu(){
    const menu = document.getElementById('navigationMenu');
    if (menu) {
      if (menu.style.display === 'none') {
        menu.style.display = 'flex';
        menu.style.opacity = '0';
        menu.style.transform = 'scale(0.9)';
        setTimeout(() => {
          menu.style.opacity = '1';
          menu.style.transform = 'scale(1)';
        }, 10);
      } else {
        menu.style.opacity = '0';
        menu.style.transform = 'scale(0.9)';
        setTimeout(() => {
          menu.style.display = 'none';
        }, 200);
      }
    }
  }



  _onResize(){
    if (!this.isScanning) return;
    if (this.engine === 'quagga'){
      Quagga.stop?.(); this._startQuagga().catch(()=>{});
    }
  }

  async stopScanner(){
    this.isScanning = false;
    this.startBtn.disabled = false;
    this.startBtn.classList.remove('btn-secondary');
    this.startBtn.classList.add('btn-success');
    this.stopBtn.disabled = true;
    this.stopBtn.classList.remove('btn-danger');
    this.stopBtn.classList.add('btn-secondary');
    this.status.textContent = "Камера остановлена";
    this._showError(""); this._flashFrame(false);
    
    // Отключаем элементы управления приближением
    if (this.zoomControls) {
      this._disableZoomControls();
    }
    
    // Сбрасываем приближение
    this.currentZoom = 1;
    
    // Сбрасываем состояние обработки
    this.isProcessing = false;
    
    // Скрываем индикатор загрузки
    this._hideLoadingOverlay();
    
    // Очищаем все поля результата
    this._clearResultFields();
    
    // Сбрасываем цвет рамки результата
    const resultElement = document.querySelector('.result');
    if (resultElement) {
      resultElement.classList.remove('actual');
    }
    
    // Скрываем индикатор версии
    const versionIndicator = document.getElementById('versionIndicator');
    if (versionIndicator) {
      versionIndicator.style.display = 'none';
    }
    
    cancelAnimationFrame(this._rafId);
    clearTimeout(this.noDetectionTimer);

    try{ Quagga.offDetected?.(()=>{}); Quagga.stop?.(); }catch(_){}
    try{ this.mediaStream?.getTracks?.().forEach(t=>t.stop()); }catch(_){}
    this.engine = null;
  }

  _resetNoDetectionTimer(){
    clearTimeout(this.noDetectionTimer);
    this.noDetectionTimer = setTimeout(()=>{
      this._handleError("Не удаётся распознать штрих-код. Проверьте освещение/резкость.");
    }, this.NO_DETECTION_MS);
  }

  _flashFrame(ok){ if (this.frameEl) this.frameEl.style.borderColor = ok ? "lime" : "#ff6b35"; }
  _handleError(msg){ this.error.textContent = msg; this.error.style.display="block"; this.status.textContent="Ошибка"; }
  _showError(msg){ this.error.style.display = msg ? "block" : "none"; this.error.textContent = msg; }

  _beep(){
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type="square"; o.frequency.setValueAtTime(880, ctx.currentTime);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.15);
      o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.16);
      setTimeout(()=>ctx.close?.(), 250);
    }catch(_){}
  }

  _beepShort(){
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type="sine"; o.frequency.setValueAtTime(660, ctx.currentTime);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.1, ctx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.08);
      o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.09);
      setTimeout(()=>ctx.close?.(), 150);
    }catch(_){}
  }
}


document.addEventListener("DOMContentLoaded", ()=> {
  new BarcodeScanner().initialize();
  optimizeForAndroid(); // Применяем оптимизации для Android
});

// Регистрация Service Worker (ОБНОВЛЕНА: относительный путь, авто-обновление)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const swUrl = new URL('./sw.js', location.href).toString();
      const reg = await navigator.serviceWorker.register(swUrl, { scope: './' });

      reg.update?.();

      if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });

      reg.addEventListener('updatefound', () => {
        const nw = reg.installing;
        if (!nw) return;
        nw.addEventListener('statechange', () => {
          if (nw.state === 'installed' && navigator.serviceWorker.controller) {
            nw.postMessage({ type: 'SKIP_WAITING' });
          }
        });
      });

      let reloaded = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (reloaded) return;
        reloaded = true;
        location.reload();
      });

      updatePWAIndicator('✅ PWA активен - работает офлайн');
    } catch (e) {
      console.log('SW register error', e);
      updatePWAIndicator('⚠️ PWA не активен');
    }
  });
}

function updatePWAIndicator(m){ const el = document.getElementById('pwa-indicator'); if (el) el.innerHTML = m; }
function checkPWAStatus(){
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistration().then(reg => {
      updatePWAIndicator(reg?.active ? '✅ PWA активен - работает офлайн' : '⏳ PWA загружается...');
    });
  } else updatePWAIndicator('❌ PWA не поддерживается');
}
document.addEventListener('DOMContentLoaded', checkPWAStatus);
        </script>
    </body>
</html>
