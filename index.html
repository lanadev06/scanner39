<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <title>ScannerOGP</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
        <style>
    :root{ --accent:#ff7a1a; --ok:#2e9b3d; }
    html,body{height:100%}
    body{overflow:hidden;background:#f3f4f6}

    /* –ì–ª–∞–≤–Ω–∞—è —Å–µ—Ç–∫–∞: –≤–µ—Ä—Ö (—Å–∫–∞–Ω–µ—Ä+–ø–∞–Ω–µ–ª—å) + –Ω–∏–∑ (–∏–Ω—Ñ–æ) ‚Äî —Å—Ç—Ä–æ–≥–æ 100vh */
    .app-grid{display:grid; grid-template-rows: 1fr auto; height:100vh; overflow:hidden; background:#f8f9fa}

    /* –í–µ—Ä—Ö–Ω—è—è —Å—Ç—Ä–æ–∫–∞ */
    .top-row,.top-row > .row{height:100%; min-height:0; overflow:hidden}
    .top-row .col, .top-row .col-auto{min-height:0; overflow:hidden}            /* –≤–∞–∂–Ω–æ –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
    #scannerRoot{position:relative; background:#000; height:100%; overflow:hidden}
    #scannerRoot video,#scannerRoot canvas{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; z-index:1}
    .scan-frame{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:min(75%,200px); height:min(65%,300px); border:3px solid var(--accent); border-radius:12px; z-index:2;
      box-shadow:0 0 0 200vmax rgba(0,0,0,.5) inset, 0 0 15px rgba(255,122,26,0.3); pointer-events:none}
    .scan-line{position:absolute; left:15%; right:15%; height:3px; background:linear-gradient(90deg, transparent, var(--accent), transparent); border-radius:2px; animation:scan 2.5s ease-in-out infinite; z-index:3; box-shadow:0 0 6px rgba(255,122,26,0.5)}
    @keyframes scan{0%,100%{top:20%}50%{top:80%}}
    .top-badge{position:absolute; left:12px; top:12px; z-index:10; background:rgba(0,0,0,.7); color:#fff; padding:8px 12px; border-radius:10px; font-size:13px; font-weight:500}

    /* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞, –Ω–µ –ª–æ–º–∞–µ—Ç –≤—ã—Å–æ—Ç—É) */
    .control-col{width:110px; max-width:110px; overflow:auto; min-width:110px; padding:1rem 0.5rem}
    @media (min-width:480px){ .control-col{width:130px; max-width:130px; min-width:130px; padding:1rem 0.75rem} }
    @media (min-width:768px){ .control-col{width:150px; max-width:150px; min-width:150px; padding:1rem 1rem} }
    @media (min-width:1200px){ .control-col{width:170px; max-width:170px; min-width:170px; padding:1rem 1.25rem} }
    .logo-tile{width:80px; height:80px; border-radius:12px; background:linear-gradient(145deg,#ffffff,#f8f9fa); border:2px solid #e9ecef; display:flex; align-items:center; justify-content:center; box-shadow:0 3px 10px rgba(0,0,0,0.08)}
    .zoom-btn{width:50px; height:50px; border-radius:10px; background:#ffffff; border:2px solid #dee2e6; font-size:20px; font-weight:600; line-height:1; box-shadow:0 2px 6px rgba(0,0,0,0.08); transition:all 0.2s ease; color:#6c757d}
    .zoom-btn:hover{transform:translateY(-1px); box-shadow:0 3px 8px rgba(0,0,0,0.12); border-color:#adb5bd}
    .zoom-btn:active{transform:translateY(0); box-shadow:0 1px 3px rgba(0,0,0,0.08)}

    /* –ù–∏–∂–Ω—è—è –∏–Ω—Ñ–æ-–ø–∞–Ω–µ–ª—å */
    .info-panel{background:linear-gradient(135deg,var(--accent) 0%,#ffa14f 100%); border-top:2px solid #e67e22; min-height:180px}
    .info-inner{max-width:1200px; margin:0 auto; padding:1rem; position:relative}
    @media (max-width:768px){ .info-inner{padding:0.75rem} }
    @media (max-width:480px){ .info-inner{padding:0.5rem} }
    .status-container{margin-bottom:0.75rem}
    .status-line{padding:0.75rem 1rem; background:#fff; border:1px solid #e9ecef; color:#333; border-radius:8px; font-weight:500; box-shadow:0 2px 6px rgba(0,0,0,0.08)}
    .error-line{display:none; padding:0.75rem 1rem; background:#fff5f5; border:1px solid #fed7d7; color:#c53030; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.08)}

    .version-status{color:var(--ok); font-weight:800; text-align:center; margin-bottom:.8rem; display:none; padding:.4rem 0; border-bottom:2px solid var(--ok); font-size:1.1rem} /* —Å–∫—Ä—ã—Ç–∞ –¥–æ —É—Å–ø–µ—Ö–∞ */
    .kv{background:#ffffff; padding:1rem 1.25rem; border-radius:10px; margin-top:0.75rem; box-shadow:0 3px 8px rgba(0,0,0,0.08); transition:all 0.3s ease; border:1px solid rgba(0,0,0,0.05)}
    .kv.success{background:#e8f5e8; border:2px solid var(--ok); box-shadow:0 4px 12px rgba(46,155,61,0.3)}
    .detail-row{display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0; border-bottom:1px solid rgba(0,0,0,0.06)}
    .detail-row:last-child{border-bottom:none}
    .kv .k{color:#495057; font-weight:500; font-size:.95rem; padding:0.25rem 0}
    .kv .v{font-weight:600; color:var(--ok); font-size:.95rem; padding:0.25rem 0}

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
    @media (max-height:680px){
      .logo-tile{width:80px;height:80px}
      .zoom-btn{width:52px;height:52px;font-size:20px}
    }
    
    @media (max-width:480px){
      .control-col{width:100px; max-width:100px; min-width:100px; padding:0.75rem 0.5rem}
      .logo-tile{width:70px;height:70px}
      .zoom-btn{width:46px;height:46px;font-size:18px}
      .btn{font-size:0.9rem !important; padding:10px 6px !important}
    }
    
    @media (max-width:375px){
      .control-col{width:95px; max-width:95px; min-width:95px; padding:0.5rem 0.25rem}
      .logo-tile{width:65px;height:65px}
      .zoom-btn{width:44px;height:44px;font-size:16px}
      .btn{font-size:0.85rem !important; padding:8px 4px !important}
    }
    
    @media (max-width:320px){
      .control-col{width:85px; max-width:85px; min-width:85px; padding:0.5rem 0.25rem}
      .logo-tile{width:60px;height:60px}
      .zoom-btn{width:40px;height:40px;font-size:14px}
      .btn{font-size:0.8rem !important; padding:6px 3px !important}
      .scan-frame{width:min(70%,180px); height:min(60%,260px)}
    }
    
    /* –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è iPhone SE */
    @media (max-width:375px) and (max-height:667px){
      .control-col{width:90px; max-width:90px; min-width:90px; padding:0.5rem 0.25rem}
      .logo-tile{width:62px;height:62px}
      .zoom-btn{width:42px;height:42px;font-size:15px}
      .btn{font-size:0.85rem !important; padding:8px 4px !important}
      .scan-frame{width:min(72%,190px); height:min(62%,280px)}
    }
        </style>
    </head>
    <body>
        <div class="app-grid">
            <div class="container-fluid g-0 top-row">
                <div class="row g-0">
                    <div class="col">
                        <div id="scannerRoot" class="position-relative">
                            <div class="top-badge badge bg-dark bg-opacity-75 text-white px-3 py-2 rounded-pill fw-semibold" id="scannerStatus" style="display:none">
                                <i class="bi bi-search me-2"></i>
                                –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ‚Ä¶
                            </div>
                            <div class="scan-frame">
                                <div class="scan-line"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto control-col bg-white border-start border-2 d-flex flex-column align-items-center py-4 px-3 shadow-sm">
                        <div class="logo-tile mb-4 d-flex align-items-center justify-content-center">
                            <img
                                src="scannerlogo.png"
                                alt="Logo"
                                class="img-fluid"
                                style="width:72px;height:72px;object-fit:contain"
                            >
                        </div>
                        <div class="d-flex flex-column align-items-center gap-3 mb-4 zoom-controls" style="display:none;opacity:0">
                            <button class="zoom-btn btn btn-outline-secondary border-2" id="zoomPlus">
                                <i class="bi bi-plus-lg fw-bold"></i>
                            </button>
                            <button class="zoom-btn btn btn-outline-secondary border-2" id="zoomMinus">
                                <i class="bi bi-dash-lg fw-bold"></i>
                            </button>
                        </div>
                        <div class="d-grid gap-3 w-100">
                            <button
                                id="stopBtn"
                                class="btn btn-danger btn-lg fw-bold shadow-sm border-0"
                                disabled
                                style="border-radius: 16px; padding: 16px 12px; font-size: 1.1rem;"
                            >
                                <i class="bi bi-stop-circle me-2"></i>
                                –°–¢–û–ü
                            </button>
                            <button id="startBtn" class="btn btn-success btn-lg fw-bold shadow-sm border-0" style="border-radius: 16px; padding: 16px 12px; font-size: 1.1rem;">
                                <i class="bi bi-play-circle me-2"></i>
                                –ü–£–°–ö
                            </button>
                            <button id="flashBtn" class="btn btn-outline-secondary btn-lg fw-bold shadow-sm" style="display:none; border-radius: 12px; padding: 12px 8px;">
                                <i class="bi bi-lightbulb me-2"></i>
                                –§–æ–Ω–∞—Ä–∏–∫
                            </button>
                        </div>
                        <div class="mt-auto small text-muted text-center px-2 py-3" id="pwa-indicator">
                            <div class="d-flex align-items-center justify-content-center">
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                <span>–ü—Ä–æ–≤–µ—Ä–∫–∞ PWA‚Ä¶</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- –ù–ò–ó -->
            <div class="info-panel">
                <div class="info-inner">
                    <div class="status-container mb-3">
                        <div id="status" class="status-line d-flex align-items-center">
                            <i class="bi bi-camera-video me-3 text-primary"></i>
                            <span>–ö–∞–º–µ—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞, –Ω–∞–∂–º–∏—Ç–µ ¬´–ø—É—Å–∫¬ª</span>
                        </div>
                        <div class="error-line alert alert-danger border-0 d-none" id="error" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span></span>
                        </div>
                    </div>
                    <div class="card border-0 shadow-sm" id="detailsCard">
                        <div class="card-body p-4">
                            <div class="version-status text-center mb-4 pb-3 border-bottom border-success border-2" id="versionStatus">
                                <h5 class="text-success fw-bold mb-0">
                                    <i class="bi bi-check-circle me-2"></i>
                                    –í–µ—Ä—Å–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞
                                </h5>
                            </div>
                            <div class="detail-row d-flex justify-content-between align-items-center py-2 border-bottom border-light">
                                <span class="k fw-medium text-muted">–®—Ç—Ä–∏—Ö-–∫–æ–¥:</span>
                                <span class="v fw-bold text-success" id="detailCode">‚Äî</span>
                            </div>
                            <div class="detail-row d-flex justify-content-between align-items-center py-2 border-bottom border-light">
                                <span class="k fw-medium text-muted">–û–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ:</span>
                                <span class="v fw-bold text-success" id="detailDesignation">‚Äî</span>
                            </div>
                            <div class="detail-row d-flex justify-content-between align-items-center py-2 border-bottom border-light">
                                <span class="k fw-medium text-muted">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</span>
                                <span class="v fw-bold text-success" id="detailName">‚Äî</span>
                            </div>
                            <div class="detail-row d-flex justify-content-between align-items-center py-2 border-bottom border-light">
                                <span class="k fw-medium text-muted">–ê–≤—Ç–æ—Ä:</span>
                                <span class="v fw-bold text-success" id="detailAuthor">‚Äî</span>
                            </div>
                            <div class="detail-row d-flex justify-content-between align-items-center py-2">
                                <span class="k fw-medium text-muted">–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:</span>
                                <span class="v fw-bold text-success" id="detailPublished">‚Äî</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ZXing & Quagga -->
        <script src="https://cdn.jsdelivr.net/npm/zxing-wasm@2/dist/iife/reader/index.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.1/dist/quagga.min.js"></script>
        <script>
class BarcodeScanner {
  constructor(){
    // UI
    this.startBtn=document.getElementById("startBtn");
    this.stopBtn=document.getElementById("stopBtn");
    this.status=document.getElementById("status");
    this.error=document.getElementById("error");
    this.versionEl=document.getElementById("versionStatus");
    this.scannerRoot=document.getElementById("scannerRoot");
    this.frameEl=document.querySelector(".scan-frame");
    this.flashBtn=document.getElementById("flashBtn");
    this.zoomControls=document.querySelector(".zoom-controls");

    // –ò–Ω—Ñ–æ-–ø–æ–ª—è (–∑–∞–≥–ª—É—à–∫–∏)
    this.detailCode=document.getElementById("detailCode");
    this.detailDesignation=document.getElementById("detailDesignation");
    this.detailName=document.getElementById("detailName");
    this.detailAuthor=document.getElementById("detailAuthor");
    this.detailPublished=document.getElementById("detailPublished");

    // –°–æ—Å—Ç–æ—è–Ω–∏—è
    this.isScanning=false; this.engine=null;
    this.videoEl=null; this.mediaStream=null; this.videoTrack=null;
    this.currentZoom=1;

    // –ê–Ω—Ç–∏–¥—Ä–µ–±–µ–∑–≥/—Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥
    this.lastCode=null; this.candidate=null; this.candidateCount=0; this.candidateFirstAt=0; this.lockedUntil=0;
    this.EMIT_STABLE_FRAMES=4; this.EMIT_STABLE_SAME_MS=400;
    this.EMIT_COOLDOWN_MS=2500;          // ‚¨Ö 2.5s –∑–∞–º–æ—Ä–æ–∑–∫–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
    this.API_COOLDOWN_MS=2500;           // ‚¨Ö –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö API-–∑–∞–ø—Ä–æ—Å–æ–≤
    this.apiCooldownUntil=0;

    this.noDetectionTimer=null; this.NO_DETECTION_MS=8000; this._rafId=0;
  }
  initialize(){
    this.startBtn.addEventListener("click",()=>this.startScanner());
    this.stopBtn.addEventListener("click",()=>this.stopScanner());
    window.addEventListener("resize",()=>this._onResize());
    document.getElementById('zoomPlus')?.addEventListener('click',()=>this._stepZoom(1));
    document.getElementById('zoomMinus')?.addEventListener('click',()=>this._stepZoom(-1));
    this._resetInfo();
  }

  _resetInfo(){
    this.detailCode.textContent='‚Äî';
    this.detailDesignation.textContent='‚Äî';
    this.detailName.textContent='‚Äî';
    this.detailAuthor.textContent='‚Äî';
    this.detailPublished.textContent='‚Äî';
    this.versionEl.classList.add('d-none');
    
    // Remove success styling from details card
    const detailsCard = document.getElementById('detailsCard');
    if (detailsCard) {
      detailsCard.classList.remove('success');
    }
  }

  async startScanner(){
    this._showError(""); this.status.textContent="–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...";
    try{
      if(await this._canUseNative()){ await this._startCamera(); this.engine='native'; this._scanNative(); }
      else if(window.ZXingWASM){ await this._startCamera(); this.engine='zxing'; await ZXingWASM.readBarcodes(new ImageData(1,1),{formats:["Code39"]}); this._scanZXing(); }
      else { await this._startQuagga(); this.engine='quagga'; }

      this.isScanning=true;
      this.startBtn.disabled=true; this.stopBtn.disabled=false;
      this.status.textContent="–°–∫–∞–Ω–µ—Ä –≥–æ—Ç–æ–≤! –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥ Code 39 (1√ó)";
      this._toggleZoomUI(); this._resetNoDetectionTimer();
    }catch(e){ this._handleError("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: "+(e?.message||e)); }
  }

  async _canUseNative(){ if(!('BarcodeDetector' in window)) return false; try{const f=await BarcodeDetector.getSupportedFormats(); return f.includes('code_39');}catch{return false;} }
  async _startCamera(){
    if(!this.videoEl){
      this.videoEl=document.createElement("video");
      this.videoEl.setAttribute("playsinline","true");
      this.videoEl.autoplay=true; this.videoEl.muted=true;
      this.scannerRoot.appendChild(this.videoEl);
    }
    this.mediaStream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:"environment"},width:{ideal:1920},height:{ideal:1080},advanced:[{focusMode:"continuous"}]}, audio:false
    });
    this.videoEl.srcObject=this.mediaStream;
    this.videoTrack=this.mediaStream.getVideoTracks()[0]||null;
    await this._applyAutoFocus(); this._setupTorchUI();
  }

  async _scanNative(){
    const detector=new BarcodeDetector({formats:['code_39']});
    const loop=async()=>{
      if(!this.isScanning||this.engine!=='native')return;
      try{ const res=await detector.detect(this.videoEl); if(res&&res.length) this._onCandidate(res[0].rawValue); }catch{}
      this._resetNoDetectionTimer(); this._rafId=requestAnimationFrame(loop);
    };
    this._rafId=requestAnimationFrame(loop);
  }
  async _scanZXing(){
    const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d');
    const opts={formats:["Code39"],tryHarder:true,tryRotate:true,tryInvert:true,tryDownscale:true,minLineCount:2,maxNumberOfSymbols:1,tryCode39ExtendedMode:true,binarizer:"LocalAverage"};
    const loop=async()=>{
      if(!this.isScanning||this.engine!=='zxing')return;
      try{ const {w,h}=this._drawROIToCanvas(this.videoEl,canvas,ctx); const img=ctx.getImageData(0,0,w,h); const r=await ZXingWASM.readBarcodes(img,opts);
        if(r&&r.length) this._onCandidate(r[0].text);
      }catch{}
      this._resetNoDetectionTimer(); this._rafId=requestAnimationFrame(loop);
    };
    this._rafId=requestAnimationFrame(loop);
  }
  _drawROIToCanvas(video,canvas,ctx){
    const vr=video.getBoundingClientRect(), fr=this.frameEl.getBoundingClientRect();
    const sx=Math.max(0,(fr.left-vr.left)/vr.width*video.videoWidth);
    const sy=Math.max(0,(fr.top -vr.top )/vr.height*video.videoHeight);
    const sw=Math.min(video.videoWidth -sx, fr.width /vr.width *video.videoWidth);
    const sh=Math.min(video.videoHeight-sy, fr.height/vr.height*video.videoHeight);
    const w=Math.max(360,Math.floor(sw)), h=Math.max(160,Math.floor(sh));
    canvas.width=w; canvas.height=h; ctx.drawImage(video,sx,sy,sw,sh,0,0,w,h); return {w,h};
  }

  async _startQuagga(){
    return new Promise((resolve,reject)=>{
      try{Quagga.offDetected?.(()=>{});}catch(_){}
      const area=this._computeROI();
      const constraints={facingMode:{ideal:"environment"},width:{ideal:1920},height:{ideal:1080},advanced:[{focusMode:"continuous"}]};
      Quagga.init({inputStream:{name:"Live",type:"LiveStream",target:this.scannerRoot,constraints,area},
        locator:{patchSize:"x-small",halfSample:false}, decoder:{readers:["code_39_reader"],multiple:false},
        locate:true, numOfWorkers:navigator.hardwareConcurrency||4, frequency:25
      },(err)=>{
        if(err) return reject(err);
        Quagga.onDetected((res)=>{ const code=res?.codeResult?.code; if(code) this._onCandidate(code); this._resetNoDetectionTimer(); });
        Quagga.start();
        setTimeout(async()=>{
          const v=this.scannerRoot.querySelector("video");
          if(v){v.setAttribute("playsinline","");v.muted=true;v.autoplay=true;}
          this.videoEl=v; this.mediaStream=v?.srcObject||null; this.videoTrack=this.mediaStream?.getVideoTracks?.()[0]||null;
          await this._applyAutoFocus(); this._setupTorchUI();
        },300);
        this._resetNoDetectionTimer(); resolve();
      });
    });
  }
  _computeROI(){
    const r=this.scannerRoot.getBoundingClientRect(), f=this.frameEl.getBoundingClientRect();
    const top=Math.max(0,(f.top-r.top)/r.height*100), left=Math.max(0,(f.left-r.left)/r.width*100);
    const right=Math.max(0,100-(f.right-r.left)/r.width*100), bottom=Math.max(0,100-(f.bottom-r.top)/r.height*100);
    return {top:`${top}%`,right:`${right}%`,left:`${left}%`,bottom:`${bottom}%`};
  }

  _onCandidate(raw){
    const now=performance.now();
    if(now<this.lockedUntil) return;                // –∑–∞–º–æ—Ä–æ–∑–∫–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
    let code=(raw||"").trim().replace(/^\*|\*$/g,""); if(!code) return;

    if(this.candidate===code) this.candidateCount++;
    else {this.candidate=code; this.candidateCount=1; this.candidateFirstAt=now;}

    const longEnough=(now-this.candidateFirstAt)>=this.EMIT_STABLE_SAME_MS;
    if(this.candidateCount>=this.EMIT_STABLE_FRAMES && longEnough) this._emitFinal(code);
  }

  async _emitFinal(code){
    const now=performance.now();

    // –¢—Ä–æ—Ç—Ç–ª–∏–Ω–≥ API: –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å—ã –≤ —Ç–µ—á–µ–Ω–∏–µ API_COOLDOWN_MS
    if(now < this.apiCooldownUntil){
      const left = Math.ceil((this.apiCooldownUntil - now)/1000);
      this.status.textContent = `–ü–æ–¥–æ–∂–¥–∏—Ç–µ‚Ä¶ (${left}—Å)`;
      return;
    }
    this.apiCooldownUntil = now + this.API_COOLDOWN_MS; // –æ–∫–Ω–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ API

    // –ó–∞–º–æ—Ä–æ–∑–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è (–æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π)
    this.lockedUntil = now + this.EMIT_COOLDOWN_MS;

    // UI
    this.lastCode = code;
    this.detailCode.textContent = code;
    this.status.textContent = `–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ`;
    this.versionEl.classList.remove('d-none');
    
    // Add success styling to details card
    const detailsCard = document.getElementById('detailsCard');
    if (detailsCard) {
      detailsCard.classList.add('success');
    }

    this._flashFrame(true); this._beep(); setTimeout(()=>this._flashFrame(false), 700);

    // –ó–∞–≥–ª—É—à–∫–∞ ¬´–ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–µ—Ä—Å–∏–∏¬ª: –∏–º–∏—Ç–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ (–ø–æ–¥–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π fetch)
    try{
      const data = await this._fakeLookup(code); // TODO: –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π fetch(...)
      this._applyDetails(data);
    }catch(e){
      this.versionEl.innerHTML = '<h5 class="text-danger fw-bold mb-0"><i class="bi bi-x-circle me-2"></i>–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h5>';
    }
  }

  _applyDetails(d){
    // –µ—Å–ª–∏ –ø–æ–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–∑–∞–≥–ª—É—à–∫—É)
    if(d.designation) this.detailDesignation.textContent = d.designation;
    if(d.name)        this.detailName.textContent = d.name;
    if(d.author)      this.detailAuthor.textContent = d.author;
    if(d.published)   this.detailPublished.textContent = d.published;
  }

  // --- –∑–∞–≥–ª—É—à–∫–∞ "API": –≤–µ—Ä–Ω–µ—Ç –Ω–∞–±–æ—Ä –ø–æ–ª–µ–π —á–µ—Ä–µ–∑ 400‚Äì600 –º—Å
  _fakeLookup(code){
    return new Promise((res)=>setTimeout(()=>{
      res({
        designation: '073–î-–ü-–≠–≠',
        name: '–¢–µ–∫—Å—Ç–æ–≤–∞—è —á–∞—Å—Ç—å',
        author: '–ß–µ—Ä–Ω–æ–≤ –Æ—Ä–∏–π',
        published: new Date().toLocaleString()
      });
    }, 400 + Math.random()*200));
  }

  async _applyAutoFocus(){
    if(!this.videoTrack?.getCapabilities) return;
    const caps=this.videoTrack.getCapabilities(); const adv=[];
    if(caps.focusMode?.includes?.("continuous")) adv.push({focusMode:"continuous"});
    if(adv.length) try{await this.videoTrack.applyConstraints({advanced:adv});}catch(_){}
  }
  _toggleZoomUI(){
    if(!this.zoomControls) return;
    if(this._checkZoomSupport()){ this.zoomControls.style.display="flex"; requestAnimationFrame(()=>this.zoomControls.style.opacity="1"); }
    else this.zoomControls.style.display="none";
  }
  _checkZoomSupport(){ if(this.videoTrack?.getCapabilities){ const z=this.videoTrack.getCapabilities().zoom; return !!(z && (z.max||1)>1.1); } return false; }
  async _applyZoom(zoom){
    if(!this.videoTrack?.getCapabilities) return;
    const caps=this.videoTrack.getCapabilities(); if(!caps.zoom) return;
    const min=caps.zoom.min??1, max=caps.zoom.max??1; const z=Math.max(min,Math.min(max,zoom));
    try{ await this.videoTrack.applyConstraints({advanced:[{zoom:z}]}); this.currentZoom=z; if(this.lastCode) this.status.textContent=`–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ`; }catch(e){ this._handleError(`–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ ${zoom}√ó`); }
  }
  _stepZoom(step){
    if(!this.videoTrack?.getCapabilities) return;
    const z=this.videoTrack.getCapabilities().zoom; if(!z) return;
    const stops=[1,2,3,4,5].filter(v=>v>=(Math.ceil(z.min??1)) && v<=(Math.floor(z.max??1)));
    if(!stops.length) return;
    const idx=stops.indexOf(this.currentZoom);
    const next=stops[Math.max(0,Math.min(stops.length-1, idx+(step>0?1:-1)))];
    if(next!==this.currentZoom) this._applyZoom(next);
  }
  _setupTorchUI(){
    if(!this.videoTrack?.getCapabilities) return;
    const caps=this.videoTrack.getCapabilities();
    if(!caps.torch){ this.flashBtn.style.display="none"; return; }
    this.flashBtn.style.display="inline-block";
    let on=false; this.flashBtn.onclick=async()=>{
      on=!on; try{ await this.videoTrack.applyConstraints({advanced:[{torch:on}]}); this.flashBtn.textContent=on?"üî¶ –§–æ–Ω–∞—Ä–∏–∫ –í–ö–õ":"üî¶ –§–æ–Ω–∞—Ä–∏–∫"; }catch(_){ on=!on; }
    };
  }

  _onResize(){ if(!this.isScanning) return; if(this.engine==='quagga'){ Quagga.stop?.(); this._startQuagga().catch(()=>{}); } }
  async stopScanner(){
    this.isScanning=false; this.startBtn.disabled=false; this.stopBtn.disabled=true;
    this.status.textContent="–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞";
    this._showError(""); this._flashFrame(false); this._resetInfo();
    if(this.zoomControls) this.zoomControls.style.display="none";
    this.currentZoom=1; cancelAnimationFrame(this._rafId); clearTimeout(this.noDetectionTimer);
    try{Quagga.offDetected?.(()=>{}); Quagga.stop?.();}catch(_){}
    try{this.mediaStream?.getTracks?.().forEach(t=>t.stop());}catch(_){}
    this.engine=null;
  }

  _resetNoDetectionTimer(){ clearTimeout(this.noDetectionTimer); this.noDetectionTimer=setTimeout(()=>this._handleError("–ù–µ —É–¥–∞—ë—Ç—Å—è —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —à—Ç—Ä–∏—Ö-–∫–æ–¥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ/—Ä–µ–∑–∫–æ—Å—Ç—å."), this.NO_DETECTION_MS); }
  _flashFrame(ok){ if(this.frameEl) this.frameEl.style.borderColor = ok ? "lime" : "var(--accent)"; }
  _handleError(msg){ 
    this.error.querySelector('span').textContent=msg; 
    this.error.classList.remove('d-none');
    this.status.classList.add('d-none');
  }
  _showError(msg){ 
    if(msg) {
      this.error.querySelector('span').textContent=msg; 
      this.error.classList.remove('d-none');
      this.status.classList.add('d-none');
    } else {
      this.error.classList.add('d-none');
      this.status.classList.remove('d-none');
    }
  }

  _beep(){ try{const c=new (window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator(),g=c.createGain();o.type="square";o.frequency.setValueAtTime(880,c.currentTime);g.gain.setValueAtTime(0.001,c.currentTime);g.gain.exponentialRampToValueAtTime(0.2,c.currentTime+0.01);g.gain.exponentialRampToValueAtTime(0.0001,c.currentTime+0.15);o.connect(g).connect(c.destination);o.start();o.stop(c.currentTime+0.16);setTimeout(()=>c.close?.(),250);}catch(_){}} 
  _beepShort(){ try{const c=new (window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator(),g=c.createGain();o.type="sine";o.frequency.setValueAtTime(660,c.currentTime);g.gain.setValueAtTime(0.001,c.currentTime);g.gain.exponentialRampToValueAtTime(0.1,c.currentTime+0.01);g.gain.exponentialRampToValueAtTime(0.0001,c.currentTime+0.08);o.connect(g).connect(c.destination);o.start();o.stop(c.currentTime+0.09);setTimeout(()=>c.close?.(),150);}catch(_){}
}
}
document.addEventListener("DOMContentLoaded",()=> new BarcodeScanner().initialize());

/* PWA (–∫–∞–∫ –±—ã–ª–æ) */
if('serviceWorker' in navigator){
  window.addEventListener('load', async ()=>{
    try{
      const swUrl=new URL('./sw.js',location.href).toString();
      const reg=await navigator.serviceWorker.register(swUrl,{scope:'./'}); reg.update?.();
      if(reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
      reg.addEventListener('updatefound',()=>{ const nw=reg.installing; if(!nw) return;
        nw.addEventListener('statechange',()=>{ if(nw.state==='installed' && navigator.serviceWorker.controller){ nw.postMessage({type:'SKIP_WAITING'}); } });
      });
      let reloaded=false;
      navigator.serviceWorker.addEventListener('controllerchange',()=>{ if(reloaded) return; reloaded=true; location.reload(); });
      const el=document.getElementById('pwa-indicator'); if(el) el.textContent='‚úÖ ScannerOGP PWA –∞–∫—Ç–∏–≤–µ–Ω ‚Äî –æ—Ñ–ª–∞–π–Ω –≥–æ—Ç–æ–≤';
    }catch(e){ const el=document.getElementById('pwa-indicator'); if(el) el.textContent='‚ö†Ô∏è PWA –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω'; }
  });
}
        </script>
    </body>
</html>
