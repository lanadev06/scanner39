<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <title>Code 39 Scanner</title>
        <meta name="description" content="–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤ Code 39 –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤">
        <meta name="theme-color" content="#ff6b35">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        <meta name="apple-mobile-web-app-title" content="Scanner39">
        <link rel="icon" type="image/svg+xml" href="icon.svg">
        <link rel="apple-touch-icon" href="icon.svg">
        <link rel="manifest" href="manifest.json">
        <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:#f5f5f5;color:#333;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px}
.container{width:100%;max-width:600px;text-align:center;background:#fff;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.1);padding:30px}
.header{margin-bottom:30px}
.logo{width:80px;height:80px;margin:0 auto 20px;background:linear-gradient(135deg,#dfcec7 0%,#ffffff 100%);border-radius:15px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;font-weight:700;box-shadow:0 5px 15px rgba(255,107,53,.3)}
.header h1{font-size:2.2em;margin-bottom:10px;color:#ff6b35}
.scanner-container{position:relative;width:100%;height:320px;background:#000;border-radius:15px;overflow:hidden}
#scannerRoot video,#scannerRoot canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:1}
.scanner-frame{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:min(88%,380px);height:150px;border:4px solid #ff6b35;border-radius:12px;
  box-shadow:0 0 0 2000px rgba(0,0,0,.3);pointer-events:none;z-index:2}
.scanner-line{position:absolute;left:0;right:0;height:3px;background:#ff6b35;animation:scan 2s infinite ease-in-out;z-index:2}
@keyframes scan{0%,100%{top:10%}50%{top:90%}}
.scan-status{position:absolute;top:10px;left:10px;background:rgba(255,107,53,.9);color:#fff;padding:5px 10px;border-radius:5px;font-size:12px;z-index:3}
.controls{margin:25px 0}
.btn{background:#ff6b35;color:#fff;border:none;padding:15px 30px;font-size:1.1em;border-radius:50px;cursor:pointer;margin:10px;transition:all .3s ease;box-shadow:0 4px 15px rgba(255,107,53,.3)}
.btn:hover{background:#f7931e;transform:translateY(-2px);box-shadow:0 6px 20px rgba(255,107,53,.4)}
.btn:disabled{background:#ccc;cursor:not-allowed;transform:none;box-shadow:none}
.result{background:linear-gradient(135deg,#ff6b35 0%,#f7931e 100%);color:#fff;padding:25px;border-radius:15px;margin:25px 0;box-shadow:0 8px 25px rgba(255,107,53,.3)}
.result h3{margin-bottom:15px;font-size:1.3em}
#resultText{font-size:2.5em;font-weight:700;color:#fff;word-break:break-all;text-shadow:2px 2px 4px rgba(0,0,0,.2)}
.status{margin:20px 0;font-style:italic;color:#666;font-size:1.1em}
.zoom-tip{margin:15px 0;font-size:.9em;color:#666;font-style:italic;background:rgba(255,107,53,.05);padding:12px;border-radius:8px;border-left:3px solid #ff6b35}
.zoom-controls{margin:20px 0;text-align:center;transition:opacity .3s ease}
.zoom-label{margin-bottom:10px;font-weight:600;color:#333;font-size:1em}
.zoom-buttons{display:flex;justify-content:center;gap:8px;flex-wrap:wrap}
.zoom-btn{background:#f0f0f0;color:#666;border:2px solid #ddd;padding:8px 16px;font-size:.9em;border-radius:20px;cursor:pointer;transition:all .3s ease;min-width:50px;transform:scale(1)}
.zoom-btn:hover{background:#e0e0e0;border-color:#ccc}
.zoom-btn.active{background:#ff6b35;color:#fff;border-color:#ff6b35;box-shadow:0 2px 8px rgba(255,107,53,.3);transform:scale(1.05)}
.zoom-btn:active{transform:scale(0.95)}
.error{color:#ff6b6b;background:rgba(255,107,53,.1);padding:15px;border-radius:10px;margin:15px 0;border:2px solid #ff6b6b}
.footer{margin-top:30px;font-size:.9em;color:#999}
@media (max-width:480px){.container{padding:20px}.header h1{font-size:1.8em}.scanner-frame{width:92%;height:130px}.btn{padding:12px 25px;font-size:1em}#resultText{font-size:2em}.zoom-tip{font-size:.8em;padding:10px}.zoom-btn{padding:6px 12px;font-size:.8em;min-width:40px}}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <div class="logo">
                    <img src="scanner.png" alt="Logo">
                </div>
                <h1>üì∑ Code 39 Scanner</h1>
            </div>
            <div class="scanner-container" id="scannerRoot">
                <div class="scanner-frame">
                    <div class="scanner-line"></div>
                </div>
                <div id="scannerStatus" class="scan-status" style="display:none;">üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...</div>
            </div>
            <div class="controls">
                <button id="startBtn" class="btn">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
                <button id="stopBtn" class="btn" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <div class="zoom-controls" style="display: none;">
                <div class="zoom-label">–ü—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ:</div>
                <div class="zoom-buttons">
                    <button class="zoom-btn active" data-zoom="1">1√ó</button>
                    <button class="zoom-btn" data-zoom="2">2√ó</button>
                    <button class="zoom-btn" data-zoom="3">3√ó</button>
                    <button class="zoom-btn" data-zoom="4">4√ó</button>
                    <button class="zoom-btn" data-zoom="5">5√ó</button>
                </div>
            </div>
            <div class="status" id="status">–ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞</div>
            <div class="zoom-tip">
                üí° –ö–Ω–æ–ø–∫–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –≤–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç zoom
            </div>
            <div class="result">
                <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
                <div id="resultText">&nbsp;</div>
            </div>
            <div id="error" class="error" style="display:none"></div>
            <div class="footer">
                <p>–†–∞–±–æ—Ç–∞–µ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö</p>
                <div id="pwa-indicator" style="margin-top:10px;font-size:.8em;color:#666;"></div>
            </div>
        </div>
        <!-- ZXing-CPP (WASM) -->
        <script src="https://cdn.jsdelivr.net/npm/zxing-wasm@2/dist/iife/reader/index.js"></script>
        <!-- Quagga2 –∫–∞–∫ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–ª–±—ç–∫ -->
        <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.1/dist/quagga.min.js"></script>
        <script>
class BarcodeScanner {
  constructor(){
    this.startBtn = document.getElementById("startBtn");
    this.stopBtn = document.getElementById("stopBtn");
    this.resultText = document.getElementById("resultText");
    this.status = document.getElementById("status");
    this.error = document.getElementById("error");
    this.scannerRoot = document.getElementById("scannerRoot");
    this.frameEl = document.querySelector(".scanner-frame");

    this.isScanning = false;
    this.engine = null; // 'native' | 'zxing' | 'quagga'
    this.videoEl = null;
    this.mediaStream = null;
    this.videoTrack = null;
    this.flashBtn = null;
    this.zoomControls = null;
    this.zoomButtons = null;
    this.currentZoom = 1;

    // –∞–Ω—Ç–∏-–¥—Ä–µ–±–µ–∑–≥
    this.lastCode = null;
    this.candidate = null;
    this.candidateCount = 0;
    this.candidateFirstAt = 0;
    this.lockedUntil = 0;
    this.EMIT_STABLE_FRAMES = 4;
    this.EMIT_STABLE_SAME_MS = 400;
    this.EMIT_COOLDOWN_MS = 1200;

    this.noDetectionTimer = null;
    this.NO_DETECTION_MS = 8000;

    this._rafId = 0;

    this.startScanner = this.startScanner.bind(this);
    this.stopScanner = this.stopScanner.bind(this);
    this._onResize = this._onResize.bind(this);
  }

  initialize(){
    this.startBtn.addEventListener("click", this.startScanner);
    this.stopBtn.addEventListener("click", this.stopScanner);
    window.addEventListener("resize", this._onResize);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ–º
    this.zoomControls = document.querySelector('.zoom-controls');
    this.zoomButtons = document.querySelectorAll('.zoom-btn');
    this._setupZoomControls();
  }

  async startScanner(){
    this._showError("");
    this.status.textContent = "–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...";
    try{
      if (await this._canUseNative()) {
        await this._startCamera();
        this.engine = 'native';
        this._scanNative();
      } else if (window.ZXingWASM) {
        await this._startCamera();
        this.engine = 'zxing';
        await ZXingWASM.readBarcodes(new ImageData(1,1), { formats: ["Code39"] }); // –ø—Ä–æ–≥—Ä–µ–≤
        this._scanZXing();
      } else {
        await this._startQuagga();
        this.engine = 'quagga';
      }

      this.isScanning = true;
      this.startBtn.disabled = true;
      this.stopBtn.disabled = false;
      this.status.textContent = "–°–∫–∞–Ω–µ—Ä –≥–æ—Ç–æ–≤! –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥ Code 39 (1√ó)";
      this.frameEl.style.display = "block";
      
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if (this.zoomControls) {
          // –°–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã–≤–∞–µ–º, –ø–æ—Ç–æ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
          this.zoomControls.style.display = "none";
          this.zoomControls.style.opacity = "0";
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã
          setTimeout(() => {
            if (this._checkZoomSupport()) {
              this.zoomControls.style.display = "block";
              // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ
              setTimeout(() => {
                this.zoomControls.style.opacity = "1";
              }, 50);
            } else {
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å, –µ—Å–ª–∏ zoom –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
              if (this.status.textContent.includes('(1√ó)')) {
                this.status.textContent = "–°–∫–∞–Ω–µ—Ä –≥–æ—Ç–æ–≤! –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥ Code 39";
              }
            }
          }, 800);
        }
      
      this._resetNoDetectionTimer();
    } catch(e){
      this._handleError("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: " + (e?.message || e));
    }
  }

  async _canUseNative(){
    if (!('BarcodeDetector' in window)) return false;
    try{
      const formats = await BarcodeDetector.getSupportedFormats();
      return formats.includes('code_39');
    }catch{ return false; }
  }

  async _startCamera(){
    if (!this.videoEl){
      this.videoEl = document.createElement("video");
      this.videoEl.setAttribute("playsinline","true");
      this.videoEl.autoplay = true;
      this.videoEl.muted = true;
      this.scannerRoot.appendChild(this.videoEl);
    }
    this.mediaStream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: "environment" },
        width: { ideal: 1920 }, height: { ideal: 1080 },
        advanced: [{ focusMode: "continuous" }]
      },
      audio: false
    });
    this.videoEl.srcObject = this.mediaStream;
    this.videoTrack = this.mediaStream.getVideoTracks()[0] || null;
    await this._applyAutoFocus();
    this._setupTorchUI();
  }

  // ======= Native (BarcodeDetector) =======
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π API –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  async _scanNative(){
    const detector = new BarcodeDetector({ formats: ['code_39'] });
    const loop = async ()=>{
      if (!this.isScanning || this.engine!=='native') return;
      try{
        const res = await detector.detect(this.videoEl);
        if (res && res.length) this._onCandidate(res[0].rawValue);
      }catch{}
      this._resetNoDetectionTimer();
      this._rafId = requestAnimationFrame(loop);
    };
    this._rafId = requestAnimationFrame(loop);
  }

  // ======= ZXing-WASM =======
  // Fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤ –±–µ–∑ –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ BarcodeDetector
  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∂–µ—Å—Ç—ã –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è –Ω–∞ —Å–≤–æ–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
  async _scanZXing(){
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    const opts = {
      formats: ["Code39"],
      tryHarder: true,
      tryRotate: true,
      tryInvert: true,
      tryDownscale: true,
      minLineCount: 2,
      maxNumberOfSymbols: 1,
      tryCode39ExtendedMode: true,
      binarizer: "LocalAverage"
    };

    const loop = async ()=>{
      if (!this.isScanning || this.engine!=='zxing') return;
      try{
        const { w, h } = this._drawROIToCanvas(this.videoEl, canvas, ctx);
        const imageData = ctx.getImageData(0,0,w,h);
        const results = await ZXingWASM.readBarcodes(imageData, opts);
        if (results && results.length) this._onCandidate(results[0].text);
      }catch{}
      this._resetNoDetectionTimer();
      this._rafId = requestAnimationFrame(loop);
    };
    this._rafId = requestAnimationFrame(loop);
  }

  _drawROIToCanvas(video, canvas, ctx){
    const vr = video.getBoundingClientRect();
    const fr = this.frameEl.getBoundingClientRect();
    const sx = Math.max(0, (fr.left - vr.left) / vr.width  * video.videoWidth);
    const sy = Math.max(0, (fr.top  - vr.top ) / vr.height * video.videoHeight);
    const sw = Math.min(video.videoWidth  - sx, fr.width  / vr.width  * video.videoWidth);
    const sh = Math.min(video.videoHeight - sy, fr.height / vr.height * video.videoHeight);
    const w = Math.max(360, Math.floor(sw));
    const h = Math.max(160, Math.floor(sh));
    canvas.width = w; canvas.height = h;
    ctx.drawImage(video, sx, sy, sw, sh, 0, 0, w, h);
    return { w, h };
  }

  // ======= Quagga2 (fallback) =======
  async _startQuagga(){
    return new Promise((resolve,reject)=>{
      try{ Quagga.offDetected?.(()=>{}); }catch(_){}
      const area = this._computeROI();
      const constraints = {
        facingMode: { ideal: "environment" },
        width:{ideal:1920}, height:{ideal:1080},
        advanced:[{ focusMode: "continuous" }]
      };
      Quagga.init({
        inputStream:{ name:"Live", type:"LiveStream", target:this.scannerRoot, constraints, area },
        locator:{ patchSize:"x-small", halfSample:false },
        decoder:{ readers:["code_39_reader"], multiple:false },
        locate:true,
        numOfWorkers: navigator.hardwareConcurrency || 4,
        frequency: 25
      }, (err)=>{
        if (err) return reject(err);
        Quagga.onDetected((res)=>{
          const code = res?.codeResult?.code;
          if (code) this._onCandidate(code);
          this._resetNoDetectionTimer();
        });
        Quagga.start();

        setTimeout(async ()=>{
          const v = this.scannerRoot.querySelector("video");
          if (v){ v.setAttribute("playsinline",""); v.muted = true; v.autoplay = true; }
          this.videoEl = v;
          this.mediaStream = v?.srcObject || null;
          this.videoTrack = this.mediaStream?.getVideoTracks?.()[0] || null;
          await this._applyAutoFocus();
          this._setupTorchUI();
        }, 300);

        this._resetNoDetectionTimer();
        resolve();
      });
    });
  }

  _computeROI(){
    const r = this.scannerRoot.getBoundingClientRect();
    const f = this.frameEl.getBoundingClientRect();
    const top = Math.max(0, (f.top - r.top)/r.height*100);
    const left= Math.max(0, (f.left- r.left)/r.width *100);
    const right = Math.max(0, 100 - (f.right - r.left)/r.width *100);
    const bottom= Math.max(0, 100 - (f.bottom- r.top )/r.height*100);
    return { top:`${top}%`, right:`${right}%`, left:`${left}%`, bottom:`${bottom}%` };
  }

  _onCandidate(raw){
    const now = performance.now();
    if (now < this.lockedUntil) return;

    let code = (raw || "").trim().replace(/^\*|\*$/g, "");
    if (!code) return;

    if (this.candidate === code){
      this.candidateCount++;
    } else {
      this.candidate = code;
      this.candidateCount = 1;
      this.candidateFirstAt = now;
    }

    const longEnough = (now - this.candidateFirstAt) >= this.EMIT_STABLE_SAME_MS;
    if (this.candidateCount >= this.EMIT_STABLE_FRAMES && longEnough){
      this._emitFinal(code);
    }
  }

  _emitFinal(code){
    this.lastCode = code;
    this.resultText.textContent = code;
    this.status.textContent = `–ì–æ—Ç–æ–≤–æ: ${code} (${this.currentZoom}√ó)`;
    this._flashFrame(true);
    this._beep();
    setTimeout(()=> this._flashFrame(false), 900);
    this.lockedUntil = performance.now() + this.EMIT_COOLDOWN_MS;
    this.candidate = null;
    this.candidateCount = 0;
    this.candidateFirstAt = 0;
  }

  async _applyAutoFocus(){
    if (!this.videoTrack?.getCapabilities) return;
    const caps = this.videoTrack.getCapabilities();
    const adv = [];
    
    // –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ñ–æ–∫—É—Å - —É–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ
    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∞–º–∏ –≤—ã–±–µ—Ä—É—Ç –Ω—É–∂–Ω–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –Ω–∞ —Å–≤–æ–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
    if (caps.focusMode?.includes?.("continuous")) {
      adv.push({ focusMode: "continuous" });
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ–∫—É—Å–∞
    if (adv.length > 0) {
      try {
        await this.videoTrack.applyConstraints({ advanced: adv });
      } catch (e) {
        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∞–≤—Ç–æ—Ñ–æ–∫—É—Å:', e);
      }
    }
  }

  _setupZoomControls(){
    if (!this.zoomButtons || !this.zoomControls) return;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è
    this._checkZoomSupport();
    
    this.zoomButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const zoom = parseInt(btn.dataset.zoom);
        if (zoom === this.currentZoom) return;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        this.zoomButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ
        await this._applyZoom(zoom);
      });
    });
  }

  _checkZoomSupport(){
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–∞–º–µ—Ä—ã
    if (this.videoTrack?.getCapabilities) {
      const caps = this.videoTrack.getCapabilities();
      
      // –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö –∫–∞–º–µ—Ä—ã
      console.log('–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–∞–º–µ—Ä—ã:', {
        zoom: caps.zoom,
        focusMode: caps.focusMode,
        torch: caps.torch
      });
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ
      if (!caps.zoom || caps.zoom.min === caps.zoom.max || caps.zoom.max <= 1.1) {
        console.log('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ');
        if (this.zoomControls) {
          this.zoomControls.style.display = "none";
        }
        return false;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è zoom
      const min = Math.ceil(caps.zoom.min ?? 1);
      const max = Math.floor(caps.zoom.max ?? 1);
      
      console.log(`–î–æ—Å—Ç—É–ø–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω zoom: ${min}x - ${max}x`);
      
      // –ï—Å–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –º–µ–Ω—å—à–µ 1.3, —Ç–æ zoom –Ω–µ –Ω—É–∂–µ–Ω
      // (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–µ–±-–∫–∞–º–µ—Ä—ã –∏–º–µ—é—Ç –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω)
      if (max < 1.3) {
        console.log('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ, zoom –Ω–µ –Ω—É–∂–µ–Ω');
        if (this.zoomControls) {
          this.zoomControls.style.display = "none";
        }
        return false;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
      this.zoomButtons.forEach((btn) => {
        const zoom = parseInt(btn.dataset.zoom);
        if (zoom >= min && zoom <= max) {
          btn.style.display = "inline-block";
        } else {
          btn.style.display = "none";
        }
      });
      
      // –ï—Å–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω zoom –º–∞–ª–µ–Ω—å–∫–∏–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
      if (max < 3) {
        this.zoomButtons.forEach((btn) => {
          const zoom = parseInt(btn.dataset.zoom);
          if (zoom > max) {
            btn.style.display = "none";
          }
        });
      }
      
      console.log('–ö–Ω–æ–ø–∫–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã');
      return true;
    }
    
    console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–∞–º–µ—Ä—ã');
    return false;
  }

  async _applyZoom(zoom){
    if (!this.videoTrack?.getCapabilities) return;
    
    try {
      const caps = this.videoTrack.getCapabilities();
      if (!caps.zoom) return;
      
      const min = caps.zoom.min ?? 1;
      const max = caps.zoom.max ?? 1;
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
      const clampedZoom = Math.max(min, Math.min(max, zoom));
      
      await this.videoTrack.applyConstraints({
        advanced: [{ zoom: clampedZoom }]
      });
      
      this.currentZoom = clampedZoom;
      console.log(`–ü—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${clampedZoom}x`);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏
      if (this.status.textContent.includes('–ì–æ—Ç–æ–≤–æ:')) {
        this.status.textContent = `–ì–æ—Ç–æ–≤–æ: ${this.lastCode} (${clampedZoom}√ó)`;
      }
      
      // –ö–æ—Ä–æ—Ç–∫–∏–π –∑–≤—É–∫–æ–≤–æ–π —Å–∏–≥–Ω–∞–ª –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è
      this._beepShort();
      
    } catch (e) {
      console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ:', e);
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      this._handleError(`–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ ${zoom}√ó`);
    }
  }

  _setupTorchUI(){
    if (!this.videoTrack?.getCapabilities) return;
    const caps = this.videoTrack.getCapabilities();
    if (!caps.torch) return;
    if (!this.flashBtn){
      this.flashBtn = document.createElement("button");
      this.flashBtn.className = "btn";
      this.flashBtn.textContent = "üî¶ –§–æ–Ω–∞—Ä–∏–∫";
      this.stopBtn.insertAdjacentElement("beforebegin", this.flashBtn);
      let on = false;
      this.flashBtn.addEventListener("click", async ()=>{
        on = !on;
        try{
          await this.videoTrack.applyConstraints({ advanced: [{ torch: on }] });
          this.flashBtn.textContent = on ? "üî¶ –§–æ–Ω–∞—Ä–∏–∫ –í–ö–õ" : "üî¶ –§–æ–Ω–∞—Ä–∏–∫";
        }catch(_){ on = !on; }
      });
    }
  }

  _onResize(){
    if (!this.isScanning) return;
    if (this.engine === 'quagga'){
      Quagga.stop?.(); this._startQuagga().catch(()=>{});
    }
  }

  async stopScanner(){
    this.isScanning = false;
    this.startBtn.disabled = false;
    this.stopBtn.disabled = true;
    this.status.textContent = "–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞";
    this._showError(""); this._flashFrame(false);
    
    // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ–º
    if (this.zoomControls) {
      this.zoomControls.style.display = "none";
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ
    this.currentZoom = 1;
    if (this.zoomButtons) {
      this.zoomButtons.forEach(btn => btn.classList.remove('active'));
      this.zoomButtons[0]?.classList.add('active'); // 1x –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }
    
    cancelAnimationFrame(this._rafId);
    clearTimeout(this.noDetectionTimer);

    try{ Quagga.offDetected?.(()=>{}); Quagga.stop?.(); }catch(_){}
    try{ this.mediaStream?.getTracks?.().forEach(t=>t.stop()); }catch(_){}
    this.engine = null;
  }

  _resetNoDetectionTimer(){
    clearTimeout(this.noDetectionTimer);
    this.noDetectionTimer = setTimeout(()=>{
      this._handleError("–ù–µ —É–¥–∞—ë—Ç—Å—è —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —à—Ç—Ä–∏—Ö-–∫–æ–¥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ/—Ä–µ–∑–∫–æ—Å—Ç—å.");
    }, this.NO_DETECTION_MS);
  }

  _flashFrame(ok){ if (this.frameEl) this.frameEl.style.borderColor = ok ? "lime" : "#ff6b35"; }
  _handleError(msg){ this.error.textContent = msg; this.error.style.display="block"; this.status.textContent="–û—à–∏–±–∫–∞"; }
  _showError(msg){ this.error.style.display = msg ? "block" : "none"; this.error.textContent = msg; }

  _beep(){
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type="square"; o.frequency.setValueAtTime(880, ctx.currentTime);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.15);
      o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.16);
      setTimeout(()=>ctx.close?.(), 250);
    }catch(_){}
  }

  _beepShort(){
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type="sine"; o.frequency.setValueAtTime(660, ctx.currentTime);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.1, ctx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.08);
      o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.09);
      setTimeout(()=>ctx.close?.(), 150);
    }catch(_){}
  }
}


document.addEventListener("DOMContentLoaded", ()=> new BarcodeScanner().initialize());

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker (–û–ë–ù–û–í–õ–ï–ù–ê: –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å, –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const swUrl = new URL('./sw.js', location.href).toString();
      const reg = await navigator.serviceWorker.register(swUrl, { scope: './' });

      reg.update?.();

      if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });

      reg.addEventListener('updatefound', () => {
        const nw = reg.installing;
        if (!nw) return;
        nw.addEventListener('statechange', () => {
          if (nw.state === 'installed' && navigator.serviceWorker.controller) {
            nw.postMessage({ type: 'SKIP_WAITING' });
          }
        });
      });

      let reloaded = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (reloaded) return;
        reloaded = true;
        location.reload();
      });

      updatePWAIndicator('‚úÖ PWA –∞–∫—Ç–∏–≤–µ–Ω - —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω');
    } catch (e) {
      console.log('SW register error', e);
      updatePWAIndicator('‚ö†Ô∏è PWA –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω');
    }
  });
}

function updatePWAIndicator(m){ const el = document.getElementById('pwa-indicator'); if (el) el.innerHTML = m; }
function checkPWAStatus(){
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistration().then(reg => {
      updatePWAIndicator(reg?.active ? '‚úÖ PWA –∞–∫—Ç–∏–≤–µ–Ω - —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω' : '‚è≥ PWA –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
    });
  } else updatePWAIndicator('‚ùå PWA –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
}
document.addEventListener('DOMContentLoaded', checkPWAStatus);
        </script>
    </body>
</html>
