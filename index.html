<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <title>Code 39 Scanner</title>
        <!-- PWA –º–µ—Ç–∞-—Ç–µ–≥–∏ -->
        <meta name="description" content="–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤ Code 39 –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤">
        <meta name="theme-color" content="#ff6b35">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        <meta name="apple-mobile-web-app-title" content="Scanner39">
        <!-- PWA –∏–∫–æ–Ω–∫–∏ -->
        <link rel="icon" type="image/svg+xml" href="icon.svg">
        <link rel="apple-touch-icon" href="icon.svg">
        <link rel="manifest" href="manifest.json">
        <style>
* {margin:0; padding:0; box-sizing:border-box;}
body {font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif; background:#f5f5f5; color:#333; min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:20px;}
.container {width:100%; max-width:600px; text-align:center; background:white; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.1); padding:30px;}
.header {margin-bottom:30px;}
.logo {width:80px; height:80px; margin:0 auto 20px; background:linear-gradient(135deg,#ff6b35 0%,#f7931e 100%); border-radius:15px; display:flex; align-items:center; justify-content:center; font-size:24px; color:white; font-weight:bold; box-shadow:0 5px 15px rgba(255,107,53,0.3);}
.header h1 {font-size:2.2em; margin-bottom:10px; color:#ff6b35;}

/* –∑–æ–Ω–∞ —Å–∫–∞–Ω–µ—Ä–∞ */
.scanner-container {position:relative; width:100%; height:300px; background:#000; border-radius:15px; overflow:hidden;}
#scannerRoot video,
#scannerRoot canvas {position:absolute; inset:0; width:100%; height:100%; object-fit:cover; z-index:1;}
.scanner-frame {position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:250px; height:120px; border:4px solid #ff6b35; border-radius:12px; box-shadow:0 0 0 2000px rgba(0,0,0,0.3); pointer-events:none; z-index:2;}
.scanner-line {position:absolute; left:0; right:0; height:3px; background:#ff6b35; animation:scan 2s infinite ease-in-out; z-index:2;}
@keyframes scan {0%,100%{top:10%;} 50%{top:90%;}}
.scan-status {position:absolute; top:10px; left:10px; background:rgba(255,107,53,0.9); color:white; padding:5px 10px; border-radius:5px; font-size:12px; z-index:3;}

.controls {margin:25px 0;}
.btn {background:#ff6b35; color:white; border:none; padding:15px 30px; font-size:1.1em; border-radius:50px; cursor:pointer; margin:10px; transition:all 0.3s ease; box-shadow:0 4px 15px rgba(255,107,53,0.3);}
.btn:hover {background:#f7931e; transform:translateY(-2px); box-shadow:0 6px 20px rgba(255,107,53,0.4);}
.btn:disabled {background:#ccc; cursor:not-allowed; transform:none; box-shadow:none;}
.result {background:linear-gradient(135deg,#ff6b35 0%,#f7931e 100%); color:white; padding:25px; border-radius:15px; margin:25px 0; box-shadow:0 8px 25px rgba(255,107,53,0.3);}
.result h3 {margin-bottom:15px; font-size:1.3em;}
#resultText {font-size:2.5em; font-weight:bold; color:white; word-break:break-all; text-shadow:2px 2px 4px rgba(0,0,0,0.2);}
.status {margin:20px 0; font-style:italic; color:#666; font-size:1.1em;}
.error {color:#ff6b6b; background:rgba(255,107,53,0.1); padding:15px; border-radius:10px; margin:15px 0; border:2px solid #ff6b6b;}
.footer {margin-top:30px; font-size:0.9em; color:#999;}
@media (max-width:480px){.container{padding:20px;} .header h1{font-size:1.8em;} .scanner-frame{width:200px;height:100px;} .btn{padding:12px 25px; font-size:1em;} #resultText{font-size:2em;}}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <div class="logo">SC</div>
                <h1>üì∑ Code 39 Scanner</h1>
            </div>
            <div class="scanner-container" id="scannerRoot">
                <div class="scanner-frame">
                    <div class="scanner-line"></div>
                </div>
                <div id="scannerStatus" class="scan-status" style="display:none;">üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...</div>
            </div>
            <div class="controls">
                <button id="startBtn" class="btn">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
                <button id="stopBtn" class="btn" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <div class="status" id="status">–ö–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞</div>
            <div class="result">
                <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
                <!-- –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –ø—Ä–æ–±–µ–ª, —á—Ç–æ–±—ã –≤–∏–∑—É–∞–ª—å–Ω–æ –ø—É—Å—Ç–æ -->
                <div id="resultText">&nbsp;</div>
            </div>
            <div id="error" class="error" style="display:none"></div>
            <div class="footer">
                <p>–†–∞–±–æ—Ç–∞–µ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö</p>
                <div id="pwa-indicator" style="margin-top: 10px; font-size: 0.8em; color: #666;"></div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.1/dist/quagga.min.js"></script>
        <script>
class BarcodeScanner {
  constructor(){
    this.startBtn=document.getElementById("startBtn");
    this.stopBtn=document.getElementById("stopBtn");
    this.resultText=document.getElementById("resultText");
    this.status=document.getElementById("status");
    this.error=document.getElementById("error");
    this.scannerRoot=document.getElementById("scannerRoot");
    this.frameEl=document.querySelector(".scanner-frame");

    this.isScanning=false;
    this.lastScannedCode=null;
    this.noDetectionTimer=null;
    this.NO_DETECTION_MS=8000;

    this.startScanner=this.startScanner.bind(this);
    this.stopScanner=this.stopScanner.bind(this);
    this.onBarcodeDetected=this.onBarcodeDetected.bind(this);
  }

  initialize(){
    this.startBtn.addEventListener("click",this.startScanner);
    this.stopBtn.addEventListener("click",this.stopScanner);
  }

  async startScanner(){
    this.showError("");
    this.status.textContent="–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...";
    try{
      await this.initQuagga();
      this.isScanning=true;
      this.startBtn.disabled=true;
      this.stopBtn.disabled=false;
      this.status.textContent="–°–∫–∞–Ω–µ—Ä –≥–æ—Ç–æ–≤! –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥ Code 39";
      this.frameEl.style.display="block";
    }catch(e){
      this.handleError("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: "+(e?.message||e));
    }
  }

  initQuagga(){
    return new Promise((resolve,reject)=>{
      try{Quagga.offDetected && Quagga.offDetected(this.onBarcodeDetected);}catch(_){}
      Quagga.init({
        inputStream:{ name:"Live", type:"LiveStream", target:this.scannerRoot,
          constraints:{ facingMode:"environment", aspectRatio:{ ideal:16/9 } } },
        decoder:{ readers:["code_39_reader"] },
        locate:true,
        numOfWorkers:navigator.hardwareConcurrency||4
      }, (err)=>{
        if(err) return reject(err);
        Quagga.onDetected(this.onBarcodeDetected);
        Quagga.start();
        setTimeout(()=>{
          const v=this.scannerRoot.querySelector("video");
          if(v){ v.setAttribute("playsinline",""); v.muted=true; v.autoplay=true; }
        },0);
        this.resetNoDetectionTimer();
        resolve();
      });
    });
  }

  resetNoDetectionTimer(){
    clearTimeout(this.noDetectionTimer);
    this.noDetectionTimer=setTimeout(()=>{
      this.handleError("–ù–µ —É–¥–∞—ë—Ç—Å—è —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —à—Ç—Ä–∏—Ö-–∫–æ–¥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ.");
    }, this.NO_DETECTION_MS);
  }

  onBarcodeDetected(res){
    const code=res?.codeResult?.code;
    if(!code) return;
    this.resetNoDetectionTimer();

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–æ–¥ –Ω–æ–≤—ã–π
    if(this.lastScannedCode !== code){
      this.lastScannedCode = code;
      this.resultText.textContent = code;
      this.status.textContent = `–®—Ç—Ä–∏—Ö-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω: ${code}`;
      this.flashFrame(true);
      // –≤–µ—Ä–Ω—É—Ç—å —Ü–≤–µ—Ç —Ä–∞–º–∫–∏ —Å–ø—É—Å—Ç—è –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è
      setTimeout(()=> this.flashFrame(false), 900);
    }
  }

  flashFrame(success){
    if(!this.frameEl) return;
    this.frameEl.style.borderColor = success ? "lime" : "#ff6b35";
  }

  async stopScanner(){
    this.isScanning=false;
    clearTimeout(this.noDetectionTimer);
    try{Quagga.offDetected && Quagga.offDetected(this.onBarcodeDetected);}catch(_){}
    try{await Quagga.stop();}catch(_){}
    // —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –æ—á–∏—â–∞–µ–º ‚Äî –æ—Å—Ç–∞—ë—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π
    this.startBtn.disabled=false;
    this.stopBtn.disabled=true;
    this.status.textContent="–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞";
    this.showError("");
    this.flashFrame(false);
  }

  handleError(msg){ this.error.textContent=msg; this.error.style.display="block"; this.status.textContent="–û—à–∏–±–∫–∞"; }
  showError(msg){ this.error.style.display = msg ? "block":"none"; this.error.textContent = msg; }
}

document.addEventListener("DOMContentLoaded", ()=> new BarcodeScanner().initialize());

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker –¥–ª—è PWA
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', registration);
        updatePWAIndicator('‚úÖ PWA –∞–∫—Ç–∏–≤–µ–Ω - —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω');
      })
      .catch(error => {
        console.log('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker:', error);
        updatePWAIndicator('‚ö†Ô∏è PWA –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω');
      });
  });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ PWA
function updatePWAIndicator(message) {
  const indicator = document.getElementById('pwa-indicator');
  if (indicator) {
    indicator.innerHTML = message;
  }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ PWA —Å—Ç–∞—Ç—É—Å–∞
function checkPWAStatus() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistration().then(registration => {
      if (registration && registration.active) {
        updatePWAIndicator('‚úÖ PWA –∞–∫—Ç–∏–≤–µ–Ω - —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω');
      } else {
        updatePWAIndicator('‚è≥ PWA –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
      }
    });
  } else {
    updatePWAIndicator('‚ùå PWA –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
  }
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', checkPWAStatus);
        </script>
    </body>
</html>
